(()=>{"use strict";class t{constructor(t,e){this.tag=t,this.index=e,this.encoded=String.fromCharCode(e)}}class e{constructor(t,e){this.tag=t,this.values=e}serialize(){return String.fromCharCode(this.tag.length+1)+this.tag+String.fromCharCode(this.values.length+1)+this.values.map((t=>String.fromCharCode(t.length+1)+t)).join("")}}const r={},s={};function n(t,n){if(n.length>128)throw new Error("An enum can only hold 128 possible values.");return r[t]=Object.fromEntries(n.map(((t,e)=>[t,e]))),s[t]=Object.fromEntries(n.map(((t,e)=>[e,t]))),new e(t,n)}var i,a;(a=i||(i={}))[a.NONE=0]="NONE",a[a.RAW=1]="RAW",a[a.STRINGS=2]="STRINGS",a[a.ENUMS=3]="ENUMS",a[a.INTS_C=4]="INTS_C",a[a.INTS_D=5]="INTS_D",a[a.INTS_A=6]="INTS_A",a[a.DECIMALS=7]="DECIMALS",a[a.BOOLEANS=8]="BOOLEANS";class o{constructor(t){this.key=1,this.keys={},this.tags={},this.packets=t,this.packetMap={},this.createPackets(t)}createKey(t){t.includes(",")?console.log(`Tag "${t}" is invalid; keys cannot contain commas.`):(this.keys[t]=this.key,this.tags[this.key]=t,this.key++)}createPackets(t){for(const e of t)this.createKey(e.tag),this.packetMap[e.tag]=e}get(t){return this.keys[t]}getChar(t){return String.fromCharCode(this.get(t))}getPacket(t){return this.packetMap[t]}has(t){return null!=this.tags[t.charCodeAt(0)]}getKeys(){return this.keys}serialize(){return this.packets.map((t=>t.serialize())).join("")}static empty(){return new o([])}}class h{constructor(t,e){this.listener=e,this.packet=t}listen(t){let e;try{if(!this.packet.validate(t))return!1;e=this.packet.processReceive(t)}catch(t){return console.error("There was an error processing the packet! This is probably my fault... report at https://github.com/cutelittlelily/sonic-ws",t),!1}return Array.isArray(e)&&!this.packet.dontSpread?this.listener(...e):this.listener(e),!0}}const c=String.fromCharCode(0),l=String.fromCharCode(1),u=String.fromCharCode(2),d=Math.floor(27647.5),p=d+1,g=[];function f(t){return t.split("").map((t=>t.charCodeAt(0)))}function C(t){return t<=d?t:-t+d}function m(t){if(t>=d||t<-d-1)throw new Error(`INT_C Numbers must be within range -${d+1} and ${d}`);return String.fromCharCode(function(t){return t<0?-t+d:t}(t))}function S(t){if(0==t)return 1;let e=1,r=p;for(;t>=r;)e++,r*=p;return e}function y(t,e){if(0==t)return c;const r=t<0;t=Math.abs(t);let s="";for(let r=0;r<e-1;r++){const n=Math.pow(p,e-r-1),i=Math.floor(t/n);s+=String.fromCharCode(i),t-=i*n}return s+=String.fromCharCode(t%p),r?f(s).map((t=>String.fromCharCode(t>0?t+d:t))).join(""):s}function w(t){return E(f(t))}function E(t){return t.reduce(((t,e,r,s)=>t+C(e)*function(t){var e;return null!==(e=g[t])&&void 0!==e?e:g[t]=Math.pow(p,t)}(s.length-r-1)),0)}function v(t,e){return[...Array(Math.ceil(t.length/e))].map(((r,s)=>t.slice(s*e,s*e+e)))}new TextEncoder;const A=(t,e)=>{let r=0;for(let s=0;s<t.length;s++){if(r++,r>e)return!1;if(s+=t.charCodeAt(s),s+1>t.length)return!1}return!0},N={[i.NONE]:t=>""==t,[i.RAW]:()=>!0,[i.STRINGS]:A,[i.ENUMS]:(t,e,r,s)=>{if(t.length>e||s>=r.enumData.length)return!1;const n=r.enumData[s];for(let r=0;r<e;r++)if(n.values.length<=t.charCodeAt(r))return!1;return!0},[i.INTS_C]:(t,e)=>t.length==e,[i.INTS_D]:(t,e)=>t.length>0&&(f(t).length-1)%t[0].charCodeAt(0)<=e,[i.INTS_A]:A,[i.DECIMALS]:(t,e)=>{let r=0;for(let s=0;s<t.length;s++){if(r++,r>e)return!1;if(s+=t.charCodeAt(s)+1,s>t.length)return!1;if(s+=t.charCodeAt(s),s>t.length)return!1}return!0},[i.BOOLEANS]:(t,e)=>{const r=f(t);return r.length<=Math.floor(e/8)+1&&null==r.find((t=>t>255))}},k={[i.NONE]:t=>"",[i.RAW]:t=>t,[i.STRINGS]:t=>{let e=[];for(let r=0;r<t.length;r++){const s=t.charCodeAt(r);e.push(t.substring(r+1,r+1+s)),r+=s}return e},[i.ENUMS]:(t,e,r,s)=>{const n=r.enumData[s];return f(t).map((t=>n.values[t]))},[i.INTS_C]:t=>f(t).map(C),[i.INTS_D]:t=>v(f(t.substring(1)),t.charCodeAt(0)).map((t=>String.fromCharCode(...t))).map(w),[i.INTS_A]:t=>{let e=[];for(let r=0;r<t.length;r++){const s=t.charCodeAt(r);e.push(w(t.substring(r+1,r+1+s))),r+=s}return e},[i.DECIMALS]:t=>{const e=f(t);let r=[];for(let t=0;t<e.length;){const s=e[t++],n=E(e.slice(t,t+s));t+=s;const i=e[t++],a=E(e.slice(t,t+i));t+=i,r.push(parseFloat(n+"."+a))}return r},[i.BOOLEANS]:(t,e)=>f(t).map((t=>{return e=t,[...Array(7)].map(((t,r)=>!!(e&1<<6-r)));var e})).flat().splice(0,e)},b={[i.NONE]:t=>"",[i.RAW]:t=>t.toString(),[i.STRINGS]:(...t)=>t.map((t=>String.fromCharCode(t.toString().length)+t)).join(""),[i.ENUMS]:(...t)=>t.map((t=>t.encoded)).join(""),[i.INTS_C]:(...t)=>t.map(m).join(""),[i.INTS_D]:(...t)=>{const e=t.reduce(((t,e)=>Math.max(t,S(e))),1),r=t.map((t=>y(t,e).padStart(e,c))).join("");return String.fromCharCode(e)+r},[i.INTS_A]:(...t)=>t.map((t=>{const e=S(t);return String.fromCharCode(e)+y(t,e)})).join(""),[i.DECIMALS]:(...t)=>t.map((t=>{const e=t.toString().split("."),r=parseFloat(e[0])||0,s=e.length>1&&parseFloat(e[1])||0,n=S(r),i=S(s);return String.fromCharCode(n)+y(r,n)+String.fromCharCode(i)+y(s,i)})).join(""),[i.BOOLEANS]:(...t)=>v(t,7).map((t=>String.fromCharCode(t.reduce(((t,e,r)=>t|e<<6-r),0)))).join("")};class T{constructor(t,e){this.tag=t,e.object?(this.type=e.types,this.dataCap=e.dataCaps,this.size=this.type.length,this.object=!0,this.receiveProcessor=function(t){const e=t.map((t=>k[t]));return(r,s,n)=>{let a=[],o=0;for(let h=0;h<r.length;){const c=r.charCodeAt(h++),l=r.substring(h,h+c);a.push(e[a.length](l,s[a.length],n,t[a.length]==i.ENUMS?o++:0)),h+=c}return a}}(this.type),this.validifier=function(t){const e=t.map((t=>N[t]));return(r,s,n)=>{let a=0,o=0;for(let h=0;h<r.length;){const c=r.charCodeAt(h++);if(c+h>r.length)return!1;const l=r.slice(h,h+=c);if(!e[a](l,s[a],n,t[a]==i.ENUMS?o++:0))return!1;if(++a>s.length)return!1}return!0}}(this.type),this.sendProcessor=function(t){const e=t.length,r=t.map((t=>b[t]));return(...t)=>{let s="";for(let n=0;n<e;n++){const e=r[n](...t[n]);s+=String.fromCharCode(e.length)+e}return s}}(this.type),this.processSend=(...t)=>this.sendProcessor(...t.flat())):(this.type=e.type,this.dataCap=e.dataCap,this.size=this.dataCap,this.object=!1,this.receiveProcessor=k[this.type],this.validifier=N[this.type],this.sendProcessor=b[this.type],this.processSend=(...t)=>this.sendProcessor(...t.flat())),this.processReceive=t=>this.receiveProcessor(t,this.dataCap,this,0),this.validate=t=>this.validifier(t,this.dataCap,this,0),this.enumData=e.enumData,this.dontSpread=e.dontSpread}serialize(){const t=this.dontSpread?u:l,e=String.fromCharCode(this.enumData.length+1)+this.enumData.map((t=>t.serialize())).join("");return this.object?t+e+String.fromCharCode(this.size+2)+String.fromCharCode(...this.dataCap.map((t=>t+1)))+String.fromCharCode(...this.type.map((t=>t+1)))+String.fromCharCode(this.tag.length+1)+this.tag:t+e+l+String.fromCharCode(this.dataCap+1)+String.fromCharCode(this.type+1)+String.fromCharCode(this.tag.length+1)+this.tag}static deserialize(t,e){const r=e,s=t[e]==u,a=t.charCodeAt(++e)-1,o=[];for(let r=0;r<a;r++){const r=t.charCodeAt(++e)-1,s=t.slice(++e,e+=r);e--;const i=t.charCodeAt(++e)-1,a=[];for(let r=0;r<i;r++){const r=t.charCodeAt(++e)-1,s=t.slice(++e,e+=r);e--,a.push(s)}o.push(n(s,a))}const h=t.charCodeAt(++e)-2;if(-1!=h){const n=++e,a=n+h,c=a,l=c+h,u=l+1,d=f(t.substring(n,a)).map((t=>t-1)),p=f(t.substring(c,l)).map((t=>t-1));let g=0;const C=p.map((t=>t==i.ENUMS?o[g++]:t)),m=t.charCodeAt(u-1)-1,S=t.substring(u,u+m);return[new T(S,M.object(C,d,s)),e-r+1+h+h+m]}const c=t.charCodeAt(++e)-1,l=t.charCodeAt(++e)-1,d=l==i.ENUMS?o[0]:l,p=++e,g=t.charCodeAt(p)-1,C=t.substring(p+1,p+1+g);return[new T(C,M.single(d,c,s)),e-r+1+g]}static deserializeAll(t){const e=[];let r=0;for(;r<t.length;){const[s,n]=this.deserialize(t,r);e.push(s),r+=n}return e}}class M{constructor(t){this.types=[],this.dataCaps=[],this.enumData=[],this.type=i.NONE,this.dataCap=-1,this.dontSpread=!1,this.object=t}static single(t,e,r){const s=new M(!1);return"number"==typeof t?s.type=t:(s.type=i.ENUMS,s.enumData=[t]),s.dataCap=e,s.dontSpread=r,s}static object(t,e,r){if(t.length!=e.length)throw new Error("There is an inbalance between types and datacaps!");const s=new M(!0);return t.forEach((t=>{"number"==typeof t?s.types.push(t):(s.types.push(i.ENUMS),s.enumData.push(t))})),s.dataCaps=e,s.dontSpread=r,s}}String.fromCharCode(3);class P{constructor(t){this.clientPackets=o.empty(),this.serverPackets=o.empty(),this.pastKeys=!1,this.readyListeners=[],this.ws=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.keyHandler=t=>this.serverKeyHandler(t),this.ws.addEventListener("message",this.keyHandler),this.ws.addEventListener("close",(t=>{this.listeners.close.forEach((e=>e(t)))}))}serverKeyHandler(t){const e=t.data.toString();if(!e.startsWith("SWS"))throw this.ws.close(1003),new Error("The server requested is not a Sonic WS server.");const r=e.charCodeAt(3);if(3!=r)throw this.ws.close(1003),new Error(`Version mismatch: ${r>3?"client":"server"} is outdated (server: ${r}, client: 3)`);const[s,n]=e.substring(4).split(c);this.clientPackets.createPackets(T.deserializeAll(s)),this.serverPackets.createPackets(T.deserializeAll(n)),Object.keys(this.preListen).forEach((t=>this.preListen[t].forEach((e=>{if(null==this.serverPackets.get(t))return console.error(new Error(`The server does not send the packet with tag "${t}"!`));const r=this.serverPackets.getPacket(t),s=new h(r,e);this.listen(t,s)})))),this.pastKeys=!0,this.readyListeners.forEach((t=>t())),this.ws.removeEventListener("message",this.keyHandler),this.ws.addEventListener("message",(t=>this.messageHandler(t)))}messageHandler(t){var e;let r=t.data.toString();if(this.listeners.message.forEach((t=>t(r))),r.length<1)return;const s=r.substring(0,1),n=r.substring(1),i=s.charCodeAt(0);null!=i&&(null===(e=this.listeners.event[i])||void 0===e||e.forEach((t=>{if(!t.listen(n))throw new Error("An error occured with data from the server!! This is probably my fault.. make an issue at https://github.com/cutelittlelily/sonic-ws")})))}listen(t,e){const r=this.serverPackets.get(t);r?(this.listeners.event[r]||(this.listeners.event[r]=[]),this.listeners.event[r].push(e)):console.log("Key is not available on server: "+t)}raw_onmessage(t){this.listeners.message.push(t)}raw_send(t){this.ws.send(t)}send(t,...e){!function(t,e,r,s){const n=t.getChar(r);if(n==c)throw new Error(`Tag "${r}" has not been created!`);const i=t.getPacket(r);if(s.length>i.size)throw new Error(`Packet "${r}" only allows ${i.size} values!`);e(n+i.processSend(s))}(this.clientPackets,(t=>this.raw_send(t)),t,e)}on_ready(t){this.pastKeys?t():this.readyListeners.push(t)}on_close(t){this.listeners.close.push(t)}on(t,e){if(this.ws.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(e);const r=this.serverPackets.getPacket(t),s=new h(r,e);this.listen(t,s)}}var I;window.SonicWS=((I=class extends P{constructor(t,e){super(new WebSocket(t,e))}static WrapEnum(e,s){return function(e,s){if(!(s in r[e]))throw new Error(`Value "${s}" does not exist in enum "${e}"`);return new t(e,r[e][s])}(e,s)}}).PacketType=i,I)})();