/*!
 * SonicWS
 * (c) 2025 Lily (liwybloc)
 * Released under the Apache-2.0 License
 * https://www.apache.org/licenses/LICENSE-2.0
 */
(()=>{"use strict";function t(t,e){const r=[];for(let n=0;n<t.length;n+=e)r.push(t.slice(n,n+e));return r}const e=255,r=Math.floor(127.5),n=r+1,s=65535,a=Math.floor(32767.5),i=Number.MAX_SAFE_INTEGER,o=r+1,h=Math.floor(r/2)+1,c=Math.pow(o,7)-1,u=(Math.floor(c/2),[]),l=t=>{var e;return null!==(e=u[t])&&void 0!==e?e:u[t]=Math.pow(n,t)},f=[],d=t=>{var e;return null!==(e=f[t])&&void 0!==e?e:f[t]=Math.pow(o,t)},p=[],m=t=>{var e;return null!==(e=p[t])&&void 0!==e?e:p[t]=Math.pow(h,t)},g=[],S=t=>{var e;return null!==(e=g[t])&&void 0!==e?e:g[t]=Math.pow(2,t)};for(let t=0;t<=3;t++)l(t),d(t),m(t),S(t);function y(t){return 256*t[0]+t[1]}function w(t,e){if(!isFinite(t))throw new Error("Can only use real numbers in shorts: "+t);const r=e?a:s,n=e?-a-1:0;if(t>r||t<n)throw new Error(`${e?"Signed ":" "}Short Numbers must be within range ${n} and ${r}`);return[Math.floor(t/256),t%256]}function T(t){return w(t<0?-t+a:t,!1)}function E(t,n){if(!isFinite(t))throw new Error("Can only use real numbers in bytes: "+t);const s=n?r:e;if(t>s||t<-s-1)throw new Error(`${n?"Signed ":" "}Byte Numbers must be within range -${s+1} and ${s}: ${t}`);return t}function v(t){return t<=r?t:-t+r}function b(t){return(t=E(t,!0))<0?-t+r:t}function N(t,e){t=Math.abs(t);let r=1;for(let n=e(1);t>=n;n=e(++r));return r}const k=N(i,l);function M(t,e,r,n,s,a){if(!isFinite(t))throw new Error("Cannot use a non-finite number: "+t);if(0==t)return Array.from({length:e}).map((()=>0));if(1==e)return[r(t)];const o=t<0;if((t=Math.abs(t))>i)throw new Error(`Non-float numbers must be within range -${i.toLocaleString()} and ${i.toLocaleString()}: ${t}`);let h=[];const c=e-1;for(let e=0;e<c;e++){const r=a(c-e),n=Math.floor(t/r);h.push(n),t-=n*r}h.push(t%s);return o?h.map((t=>t>0?t+n:t)):h}function A(t){return 0==t.length?v(t[0]):t.reduce(((t,e,r,n)=>t+v(e)*l(n.length-r-1)),0)}function R(t){return Number("0b"+t)}function B(e,r,n){return t(e.toString(2)+r.toString(2).padStart(8,"0")+n.toString(2).padStart(23,"0"),8).map((t=>R(t)))}function I(t){if(isNaN(t))return B(0,255,4919);const e=t<0?1:0;if(0==(t=Math.abs(t)))return B(e,0,0);const r=Math.floor(Math.log(t)/Math.LN2);if(r>127||r<-126)return B(e,255,0);const n=t/S(r);return B(e,r+127,8388607&Math.round((n-1)*S(23)))}function P(t){const e=t.map((t=>t.toString(2).padStart(8,"0"))).join(""),r=R(e[0]),n=R(e.slice(1,9)),s=0===n?-126:n-127;return(0==r?1:-1)*function(t,e){const r=R(t);let n=0;for(let t=0;t<23;t++)r&1<<23-t-1&&(n+=S(-(t+1)));return(e?1:0)+n}(e.slice(9,32),0!==n)*S(s)}function U(t){return t<<1^t>>15}function O(t){return t>>>1^-(1&t)}function $(t){return w(U(t),!1)}function x(t){return t<0?t|h:t}function L(t,e,r,n,s,a){if(t>r||t<e)throw new Error(`${a?"Signed ":""}Variable Ints must be within range ${e} and ${r}: ${t}`);return M(t,N(t,n),x,h,s,n).map(((t,e)=>0==e?t:128|t)).reverse()}function z(t,e){return e?L(t,-c-1,c,m,h,!0):L(t,0,c,d,o,!1)}function _(t,e,r){let n,s=[];do{const r=t[e++];n=!!(128&r),s.push(n?128^r:r)}while(n);const a=r?m:d,i=s.reduce(((t,e,n)=>t+function(t,e){return e&&t&h?-(t^h):t}(e,r)*a(n)),0);return[e,i]}function Z(t){return Array.from(t,(t=>t.codePointAt(0)))}function H(t){return String.fromCodePoint(...t)}function F(t){return t>=55296&&t<=57343}function D(t){if(t<=65535){if(F(t))throw new Error(`Cannot send code point ${t}; must be out of range 55296 and 57343`);return[t]}if(t>1114111)throw new Error(`Cannot send code ${t}`);return[55296+((t-=65536)>>10),56320+(1023&t)]}const V={string:0,number:1,boolean:2,undefined:3,object:4},K={0:t=>t,1:t=>parseFloat(t),2:t=>"true"==t,3:()=>{},4:()=>null};function C(t){const e=typeof t;if(!(e in V)&&null!=t)throw new Error(`Cannot serialize type "${e}" in an enum!`);return V[e]}class j{constructor(t,e){this.tag=t,this.values=e}serialize(){const t=Z(this.tag);return[this.tag.length,...t,this.values.length,...this.values.map((t=>[String(t).length,C(t),...Z(String(t))])).flat()]}}const Y={},G={};function W(t,e){if(e.length>255)throw new Error("An enum can only hold 255 possible values.");return Y[t]=Object.fromEntries(e.map(((t,e)=>[t,e]))),G[t]=Object.fromEntries(e.map(((t,e)=>[e,t]))),new j(t,e)}var q;function J(t,e){const r=new Uint8Array(1+e.length);return r[0]=t,r.set(e,1),r}function X(e,r){return t(Array.from(e),r)}function Q(t){return H(Array.from(t))}function tt(t){return function(t){let e=[];for(let r=0;r<t.length;r++){const n=t[r];if(F(n)){if(r==t.length-1)throw new Error(`Terminated surrogate pair; index ${r} value ${n}`);const s=t[++r];if(!F(s))throw new Error(`Terminated surrogate pair; index ${r} value ${n} next value ${s}`);e.push(1024*(n-55296)+(s-56320)+65536)}else e.push(n)}return H(e)}(X(t,2).map((t=>y(t))))}function et(t,e){return r=>r.length>=e&&r.length<=t}function rt(t,e){return e*=2,t*=2,r=>r.length>=e&&r.length<=t&&r.length%2==0}function nt(t,e,r){return n=>{if(0==n.length)return!1;let s=0,a=0,i=[];for(;a<n.length;){const[e,o]=_(n,a,r);if(a=e,i.push(o),++s>t)return!1}return!(s<e)&&i}}function st(t,e,r,n){switch(t){case q.NONE:return t=>0==t.length;case q.RAW:return()=>{};case q.ENUMS:return(t,s)=>{if(t.length<r||t.length>e||s>=n.length)return!1;const a=n[s];for(let e=0;e<t.length;e++)if(a.values.length<=t[e])return!1};case q.BYTES:case q.UBYTES:case q.BYTES_ZZ:return et(e,r);case q.SHORTS:case q.USHORTS:case q.SHORTS_ZZ:return rt(e,r);case q.NUMBERS:return t=>{if(0==t.length)return!1;const n=t[0];if(n>k)return!1;const s=t.length-1;if(s%n!=0)return!1;const a=s/n;return!(a<r||a>e)&&void 0};case q.VARINT:return nt(e,r,!0);case q.UVARINT:case q.VARINT_ZZ:case q.DELTAS:return nt(e,r,!1);case q.FLOAT:return t=>{if(t.length%4!=0)return!1;const n=t.length/4;return!(n>e||n<r)&&void 0};case q.BOOLEANS:{const t=Math.floor(r/8),n=Math.floor(e/8);return e=>e.length>=t&&e.length<=n}case q.STRINGS_ASCII:return t=>{let n=0,s=0,a=[];for(;s<t.length;){if(n++,n>e)return!1;const[r,i]=_(t,s,!1);if(s=r+i,a.push(i),s>t.length)return!1}return!(n<r)&&a};case q.STRINGS_UTF16:return t=>{let n=0,s=0,a=[];for(;s<t.length;){if(n++,n>e)return!1;const[r,i]=_(t,s,!1);if(s=r+2*i,a.push(i),s>t.length)return!1}return!(n<r)&&a};default:throw new Error("Unknown type: "+t)}}function at(e,r,n){switch(e){case q.NONE:return()=>{};case q.RAW:return t=>t;case q.BYTES:return t=>Array.from(t).map(v);case q.UBYTES:return t=>Array.from(t);case q.BYTES_ZZ:return t=>Array.from(t).map(O);case q.SHORTS:return t=>X(t,2).map((t=>function(t){const e=y(t);return e<=a?e:-e+a}(t)));case q.USHORTS:return t=>X(t,2).map((t=>y(t)));case q.SHORTS_ZZ:return t=>X(t,2).map((t=>O(y(t))));case q.VARINT:case q.UVARINT:return(t,e)=>e;case q.VARINT_ZZ:return(t,e)=>e.map(O);case q.DELTAS:return(t,e)=>e.map(((t,r)=>e[r]=(e[r-1]||0)+O(t)));case q.FLOAT:return t=>X(t,4).map(P);case q.BOOLEANS:return t=>Array.from(t).map((t=>{return e=t,[...Array(8)].map(((t,r)=>!!(e&1<<7-r)));var e})).flat().splice(0,n);case q.NUMBERS:return e=>t(e.subarray(1),e[0]).map(A);case q.ENUMS:return(t,e,n)=>{const s=r[n];return Array.from(t).map((t=>s.values[t]))};case q.STRINGS_ASCII:return(t,e)=>{let r=0;return e.map((e=>Q(t.subarray(++r,r+=e))))};case q.STRINGS_UTF16:return(t,e)=>{let r=0;return e.map((e=>tt(t.subarray(++r,r+=2*e))))};default:throw new Error("Unknown type: "+e)}}function it(s){switch(s){case q.NONE:return()=>[];case q.RAW:return t=>Array.from(t);case q.ENUMS:return t=>t;case q.BYTES:return t=>t.map(b);case q.UBYTES:return t=>t.map((t=>E(t,!1)));case q.BYTES_ZZ:return t=>t.map(U);case q.SHORTS:return t=>t.map(T).flat();case q.USHORTS:return t=>t.map((t=>w(t,!1))).flat();case q.SHORTS_ZZ:return t=>t.map($).flat();case q.VARINT:return t=>t.map((t=>z(t,!0))).flat();case q.UVARINT:return t=>t.map((t=>z(t,!1))).flat();case q.VARINT_ZZ:return t=>t.map((t=>z(U(t),!1))).flat();case q.DELTAS:return t=>t.map(((e,r)=>z(U(e-(t[r-1]||0)),!1))).flat();case q.FLOAT:return t=>t.map(I).flat();case q.BOOLEANS:return e=>t(e,8).map((t=>t.reduce(((t,e,r)=>t|e<<7-r),0))).flat();case q.NUMBERS:return t=>{const e=[],s=t.reduce(((t,e)=>Math.max(t,N(e,l))),1);return e.push(s),t.forEach((t=>{return(a=t,i=s,M(a,i,b,r,n,l)).forEach((t=>e.push(t)));var a,i})),e};case q.STRINGS_ASCII:return t=>{const r=[];for(const n of t){const t=String(n);r.push(...z(t.length,!1));const s=Z(t),a=s.find((t=>t>e));if(a)throw new Error(`Cannot store code ${a} (${String.fromCharCode(a)}) in a UTF-8 String! Use STRINGS_UTF16.`);s.map((t=>r.push(t)))}return r};case q.STRINGS_UTF16:return t=>{const e=[];for(const r of t){const t=String(r);e.push(...z(t.length,!1)),Z(t).map((t=>e.push(...D(t).map((t=>w(t,!1))).flat())))}return e};default:throw new Error("Unknown type: "+s)}}!function(t){t[t.NONE=0]="NONE",t[t.RAW=1]="RAW",t[t.STRINGS_ASCII=2]="STRINGS_ASCII",t[t.STRINGS_UTF16=3]="STRINGS_UTF16",t[t.STRINGS=2]="STRINGS",t[t.ENUMS=4]="ENUMS",t[t.BYTES=5]="BYTES",t[t.UBYTES=6]="UBYTES",t[t.BYTES_ZZ=7]="BYTES_ZZ",t[t.SHORTS=8]="SHORTS",t[t.USHORTS=9]="USHORTS",t[t.SHORTS_ZZ=10]="SHORTS_ZZ",t[t.NUMBERS=11]="NUMBERS",t[t.VARINT=12]="VARINT",t[t.UVARINT=13]="UVARINT",t[t.VARINT_ZZ=14]="VARINT_ZZ",t[t.DELTAS=15]="DELTAS",t[t.FLOAT=16]="FLOAT",t[t.BOOLEANS=17]="BOOLEANS"}(q||(q={}));class ot{constructor(t,e,r,n,s){this.tag=t,this.defaultEnabled=n,this.client=s,this.enumData=e.enumData,this.rateLimit=e.rateLimit,this.dontSpread=e.dontSpread,this.autoFlatten=e.autoFlatten,this.dataBatching=e.dataBatching,this.maxBatchSize=s?1/0:e.maxBatchSize,this.object=e.object,this.object?(this.type=e.types,this.dataMax=e.dataMaxes,this.dataMin=e.dataMins,this.maxSize=this.type.length,this.minSize=this.type.length,this.receiveProcessor=function(t){const e=t.type,r=t.dataMax,n=e.map(((e,n)=>at(e,t.enumData,r[n])));return(t,r)=>{let s=0,a=0,i=[];for(;s<t.length;){const[o,h]=_(t,s,!1);s=o;const c=t.subarray(s,s+=h);i.push(n[i.length](c,r[i.length],e[i.length]==q.ENUMS?a++:0))}return i}}(this),this.validator=function(t){const e=t.type,r=t.dataMax,n=t.dataMin,s=e.map(((e,s)=>st(e,r[s],n[s],t.enumData)));return t=>{let r=0,n=0,a=[];for(;r<t.length;){if(a.length>e.length)return!1;const[i,o]=_(t,r,!1);if(r=i,o+r>t.length)return!1;const h=t.subarray(r,r+=o),c=s[a.length](h,e[a.length]==q.ENUMS?n++:0);if(0==c)return!1;a.push(c)}return a}}(this),this.sendProcessor=function(t){const e=t.type,r=e.length,n=e.map((t=>it(t)));return t=>{let e=[];for(let s=0;s<r;s++){const r=t[s],a=n[s](Array.isArray(r)?r:[r]);if(a.length>c)throw new Error(`Cannot send ${a.length}/${c} bytes of data!`);e.push(...z(a.length,!1)),a.forEach((t=>e.push(t)))}return e}}(this)):(this.type=e.type,this.dataMax=e.dataMax,this.dataMin=e.dataMin,this.maxSize=this.dataMax,this.minSize=this.dataMin,this.receiveProcessor=at(this.type,this.enumData,this.dataMax),this.validator=st(this.type,this.dataMax,this.dataMin,this.enumData),this.sendProcessor=it(this.type)),this.processReceive=(t,e)=>this.receiveProcessor(t,e,0),this.processSend=t=>this.sendProcessor(t),this.validate=t=>this.validator(t,0),this.customValidator=r,this.serializeNumber=this.serializeNumber.bind(this)}listen(t,e){try{const r=this.validate(t);if(!this.client&&0==r)return"Invalid packet";const n=this.processReceive(t,r),s=this.autoFlatten?ut(n):n;if(null!=this.customValidator)if(this.dontSpread){if(!this.customValidator(e,s))return"Didn't pass custom validator"}else if(!this.customValidator(e,...s))return"Didn't pass custom validator";return[s,!this.dontSpread]}catch(t){return console.error("There was an error processing the packet! This is probably my fault... report at https://github.com/cutelittlelily/sonic-ws",t),"Error: "+t}}serializeNumber(t){return z(t,!1)}serialize(){const t=[this.tag.length,...Z(this.tag),this.dontSpread?1:0,this.dataBatching,this.maxBatchSize,this.enumData.length,...this.enumData.map((t=>t.serialize())).flat()];return this.object?[...t,this.maxSize+1,this.autoFlatten?1:0,...this.dataMax.map(this.serializeNumber).flat(),...this.dataMin.map(this.serializeNumber).flat(),...this.type,this.tag.length]:[...t,0,...this.serializeNumber(this.dataMax),...this.serializeNumber(this.dataMin),this.type]}static readVarInts(t,e,r){const n=[];for(let s=0;s<r;s++){const[r,s]=_(t,e,!1);e=r,n.push(s)}return[n,e]}static deserialize(t,e,r){const n=e,s=t[e++],a=Q(t.slice(e,e+=s)),i=1==t[e++],o=t[e++],h=t[e++],c=t[e++],u=[];for(let r=0;r<c;r++){const r=t[e++],n=Q(t.slice(e,e+=r)),s=t[e++],a=[];for(let r=0;r<s;r++){const r=t[e++],n=t[e++],s=Q(t.slice(e,e+=r));a.push(K[n](s))}u.push(W(n,a))}const l=t[e++]-1;if(-1!=l){const s=1==t[e++],[c,f]=this.readVarInts(t,e,l);e=f;const[d,p]=this.readVarInts(t,e,l);e=p;const m=Array.from(t.slice(e,e+=l));let g=0;const S=m.map((t=>t==q.ENUMS?u[g++]:t)),y=ht.object(S,c,d,i,s,o,h,-1);return[new ot(a,y,null,!1,r),e-n+1]}const[f,d]=_(t,e,!1);e=f;const[p,m]=_(t,e,!1),g=t[e=p],S=g==q.ENUMS?u[0]:g,y=ht.single(S,d,m,i,o,h,-1);return[new ot(a,y,null,!1,r),e-n+1]}static deserializeAll(t,e){const r=[];let n=0;for(;n<t.length;){const[s,a]=this.deserialize(t,n,e);r.push(s),n+=a}return r}}class ht{constructor(t){this.types=[],this.dataMaxes=[],this.dataMins=[],this.type=q.NONE,this.dataMax=-1,this.dataMin=-1,this.dataBatching=0,this.maxBatchSize=10,this.rateLimit=0,this.enumData=[],this.dontSpread=!1,this.autoFlatten=!1,this.object=t}static single(t,e,r,n,s,a,i){const o=new ht(!1);return"number"==typeof t?(o.type=t,t==q.NONE&&(e=r=0)):(o.type=q.ENUMS,o.enumData=[t]),o.dataMax=e,o.dataMin=r,o.dontSpread=n,o.dataBatching=s,o.maxBatchSize=a,o.rateLimit=i,o}static object(t,e,r,n,s,a,i,o){if(t.length!=e.length||t.length!=r.length)throw new Error("There is an inbalance between the amount of types, data maxes, and data mins!");const h=new ht(!0);return t.forEach((t=>{"number"==typeof t?h.types.push(t):(h.types.push(q.ENUMS),h.enumData.push(t))})),h.dataMaxes=e,h.dataMins=r,h.dontSpread=n,h.autoFlatten=s,h.dataBatching=a,h.maxBatchSize=i,h.rateLimit=o,h}}function ct(t){var e;if(null==t)return[];const r=t[0];if(null==r)return[];if(!Array.isArray(r))throw new Error(`Cannot flatten array: ${t}`);return null!==(e=r.map(((e,r)=>t.map((t=>t[r])))))&&void 0!==e?e:[]}function ut(t){var e,r;return null!==(r=null===(e=t[0])||void 0===e?void 0:e.map(((e,r)=>t.map((t=>t[r])))))&&void 0!==r?r:[]}class lt{constructor(t){this.key=1,this.keys={},this.tags={},this.packetMap={},t&&(this.packets=t,this.holdPackets(t))}createKey(t){this.keys[t]=this.key,this.tags[this.key]=t,this.key++}holdPackets(t){for(const e of t)this.createKey(e.tag),this.packetMap[e.tag]=e}getKey(t){if(!(t in this.keys))throw new Error(`Not a valid tag: ${t}`);return this.keys[t]}getTag(t){return this.tags[t]}getPacket(t){if(!(t in this.packetMap))throw new Error("Unknown packet tag: "+t);return this.packetMap[t]}hasKey(t){return t in this.tags}hasTag(t){return t in this.keys}getKeys(){return this.keys}getTagMap(){return this.tags}getTags(){return Object.values(this.tags)}getPackets(){return this.packets}serialize(){return this.packets.map((t=>t.serialize())).flat()}}Z("SWS");class ft{constructor(){this.batchTimes={},this.batchTimeouts={},this.batchedData={}}registerSendPackets(t,e){this.conn=e,t.getTags().forEach((e=>{const r=t.getPacket(e);if(0==r.dataBatching)return;const n=t.getKey(e);this.initiateBatch(n,r.dataBatching)}))}initiateBatch(t,e){this.batchedData[t]=[],this.batchTimes[t]=e}startBatch(t){this.batchTimeouts[t]=this.conn.setTimeout((()=>{this.conn.raw_send(J(t,this.batchedData[t])),this.batchedData[t]=[],delete this.batchTimeouts[t]}),this.batchTimes[t])}batchPacket(t,e){const r=this.batchedData[t];r.push(...z(e.length,!1)),e.forEach((t=>r.push(t))),this.batchTimeouts[t]||this.startBatch(t)}static unravelBatch(t,e,r){const n=[];for(let s=0;s<e.length;){if(0!=t.maxBatchSize&&n.length>t.maxBatchSize)return"Too big of batch";const[a,i]=_(e,s,!1);if(s=a,s+i>e.length)return"Tampered batch length";const o=e.slice(s,s+=i),h=t.listen(o,r);if("string"==typeof h)return"Batched packet: "+h;n.push([h[0],!t.dontSpread])}return n}}var dt=function(t,e,r,n){return new(r||(r=Promise))((function(s,a){function i(t){try{h(n.next(t))}catch(t){a(t)}}function o(t){try{h(n.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,o)}h((n=n.apply(t,e||[])).next())}))};class pt{constructor(t,e){this.clientPackets=new lt,this.serverPackets=new lt,this.pastKeys=!1,this.readyListeners=[],this.id=-1,this.timers={},this.reading=!1,this.socket=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.batcher=new ft,this.invalidPacket=this.invalidPacket.bind(this),this.serverKeyHandler=this.serverKeyHandler.bind(this),this.messageHandler=this.messageHandler.bind(this),this.socket.addEventListener("message",this.serverKeyHandler),this.socket.addEventListener("close",(t=>{this.listeners.close.forEach((e=>e(t))),Object.values(this.timers).forEach(clearTimeout)})),this.bufferHandler=e}serverKeyHandler(t){return dt(this,void 0,void 0,(function*(){if(this.reading)return this.messageHandler(t);this.reading=!0;const e=yield this.bufferHandler(t);if(e.length<3||"SWS"!=Q(e.slice(0,3)))throw this.socket.close(1e3),new Error("The server requested is not a Sonic WS server.");if(3==e.length)return;const r=e[3];if(10!=r)throw this.socket.close(1e3),new Error(`Version mismatch: ${r>10?"client":"server"} is outdated (server: ${r}, client: 10)`);const[n,s]=_(e,4,!1),a=e.slice(n,n+s);this.clientPackets.holdPackets(ot.deserializeAll(a,!0));const i=e.slice(n+s,e.length-1);this.serverPackets.holdPackets(ot.deserializeAll(i,!0)),this.id=e[e.length-1],this.batcher.registerSendPackets(this.clientPackets,this),Object.keys(this.preListen).forEach((t=>this.preListen[t].forEach((e=>{if(null==this.serverPackets.getKey(t))return console.error(new Error(`The server does not send the packet with tag "${t}"!`));this.listen(t,e)})))),this.preListen=null,this.pastKeys=!0,this.readyListeners.forEach((t=>t())),this.readyListeners=null,this.socket.removeEventListener("message",this.serverKeyHandler),this.socket.addEventListener("message",this.messageHandler)}))}invalidPacket(t){throw console.log(t),new Error("An error occured with data from the server!! This is probably my fault.. make an issue at https://github.com/cutelittlelily/sonic-ws")}listenPacket(t,e){const r=this.listeners.event[e];if(!r)return console.warn("Warn: No listener for packet "+this.serverPackets.getTag(e));!function(t,e,r){if("string"==typeof t)return r(t);const[n,s]=t;try{s&&Array.isArray(n)?e.forEach((t=>t(...n))):e.forEach((t=>t(n)))}catch(t){r(t)}}(t,r,this.invalidPacket)}messageHandler(t){return dt(this,void 0,void 0,(function*(){const e=yield this.bufferHandler(t);if(this.listeners.message.forEach((t=>t(e))),e.length<1)return;const r=e[0],n=e.slice(1),s=this.serverPackets.getPacket(this.serverPackets.getTag(r));if(0==s.dataBatching)return void this.listenPacket(s.listen(n,null),r);const a=ft.unravelBatch(s,n,null);if("string"==typeof a)return this.invalidPacket(a);a.forEach((t=>this.listenPacket(t,r)))}))}listen(t,e){const r=this.serverPackets.getKey(t);r?(this.listeners.event[r]||(this.listeners.event[r]=[]),this.listeners.event[r].push(e)):console.log("Key is not available on server: "+t)}raw_onmessage(t){this.listeners.message.push(t)}raw_send(t){this.socket.send(t)}send(t,...e){const[r,n,s]=function(t,e,r){const n=t.getKey(e),s=t.getPacket(e);if(s.autoFlatten)r=ct(r[0]);else{if(r.length>s.maxSize)throw new Error(`Packet "${e}" only allows ${s.maxSize} values!`);if(r.length<s.minSize)throw new Error(`Packet "${e}" requires at least ${s.minSize} values!`)}if(s.object){if(r=r.map((t=>Array.isArray(t)?t:[t])),!s.autoFlatten){const t=s.dataMin,n=s.dataMax;for(let s=0;s<t.length;s++){if(r[s].length<t[s])throw new Error(`Section ${s+1} of packet "${e}" requires at least ${t[s]} values!`);if(r[s].length>n[s])throw new Error(`Section ${s+1} of packet "${e}" only allows ${n[s]} values!`)}}}else{const t=r.find((t=>"object"==typeof t&&null!=t));t&&console.warn(`Passing an array will result in undefined behavior (${JSON.stringify(t)}). Spread the array with ...arr`)}return[n,r.length>0?s.processSend(r):[],s]}(this.clientPackets,t,e);0==s.dataBatching?this.raw_send(J(r,n)):this.batcher.batchPacket(r,n)}on_ready(t){this.pastKeys?t():this.readyListeners.push(t)}on_close(t){this.listeners.close.push(t)}on(t,e){if(this.socket.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(e);this.listen(t,e)}setTimer(t){this.timers[t]=t}setTimeout(t,e){const r=setTimeout((()=>{t(),this.clearTimeout(r)}),e);return this.setTimer(r),r}setInterval(t,e){const r=setInterval(t,e);return this.setTimer(r),r}clearTimeout(t){clearTimeout(t),delete this.timers[t]}clearInterval(t){this.clearTimeout(t)}close(t,e){this.socket.close(t,e)}}var mt=function(t,e,r,n){return new(r||(r=Promise))((function(s,a){function i(t){try{h(n.next(t))}catch(t){a(t)}}function o(t){try{h(n.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,o)}h((n=n.apply(t,e||[])).next())}))};window.SonicWS=class extends pt{constructor(t,e){super(new WebSocket(t,e),(t=>mt(this,void 0,void 0,(function*(){return new Uint8Array(yield t.data.arrayBuffer())}))))}WrapEnum(t,e){return function(t,e){if(!(e in Y[t]))throw new Error(`Value "${e}" does not exist in enum "${t}"`);return Y[t][e]}(t,e)}FlattenData(t){return ct(t)}UnFlattenData(t){return ut(t)}}})();