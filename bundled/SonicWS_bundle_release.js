(()=>{"use strict";function t(t,r){return function(t,r,e){if(e||2===arguments.length)for(var n,o=0,i=r.length;o<i;o++)!n&&o in r||(n||(n=Array.prototype.slice.call(r,0,o)),n[o]=r[o]);return t.concat(n||Array.prototype.slice.call(r))}([],Array(Math.ceil(t.length/r)),!0).map((function(e,n){return t.slice(n*r,n*r+r)}))}var r,e,n,o,i,a=String.fromCharCode(0),s=(String.fromCharCode(1),Math.floor(27647.5)),c=s+1,u=[];function h(t){return t.split("").map((function(t){return t.charCodeAt(0)}))}function f(t){return t<s?t:-t+s}function l(t){if(t>=s||t<-s-1)throw new Error("INT_C Numbers must be within range -".concat(s+1," and ").concat(s));return String.fromCharCode(function(t){return t<0?-t+s:t}(t))}function p(t){if(0==t)return 1;for(var r=1,e=c;t>e;)r++,e*=c;return r}function d(t,r){if(0==t)return a;var e=t<0;t=Math.abs(t);for(var n="",o=0;o<r-1;o++){var i=Math.pow(c,r-o-1),u=Math.floor(t/i);n+=String.fromCharCode(u),t-=u*i}return n+=String.fromCharCode(t%c),e?h(n).map((function(t){return String.fromCharCode(t>0?t+s:t)})).join(""):n}function g(t){return v(h(t))}function v(t){return t.reduce((function(t,r,e,n){return t+f(r)*function(t){var r;return null!==(r=u[t])&&void 0!==r?r:u[t]=Math.pow(c,t)}(n.length-e-1)}),0)}new TextEncoder,(i=o||(o={}))[i.NONE=0]="NONE",i[i.RAW=1]="RAW",i[i.STRING=1]="STRING",i[i.INTS_C=2]="INTS_C",i[i.INTS_D=3]="INTS_D",i[i.INTS_A=4]="INTS_A",i[i.DECIMALS=5]="DECIMALS",i[i.BOOLEANS=6]="BOOLEANS";var y=((r={})[o.NONE]=function(t){return""==t},r[o.RAW]=function(){return!0},r[o.INTS_C]=function(t,r){return t.length==r},r[o.INTS_D]=function(t,r){return t.length>0&&(h(t).length-1)%t[0].charCodeAt(0)<=r},r[o.INTS_A]=function(t,r){for(var e=0,n=0;n<t.length;n++){if(++e>r)return!1;if((n+=t.charCodeAt(n))+1>t.length)return!1}return!0},r[o.DECIMALS]=function(t,r){for(var e=0,n=0;n<t.length;){if(++e>r)return!1;if((n+=t.charCodeAt(n++))>t.length)return!1;if((n+=t.charCodeAt(n++))>t.length)return!1}return!0},r[o.BOOLEANS]=function(t,r){var e=h(t);return e.length<Math.floor(r/8)+1&&null==e.find((function(t){return t>255}))},r),C=((e={})[o.NONE]=function(t){return""},e[o.RAW]=function(t){return t},e[o.INTS_C]=function(t){return h(t).map(f)},e[o.INTS_D]=function(r){return t(h(r.substring(1)),r[0].charCodeAt(0)).map((function(t){return String.fromCharCode.apply(String,t)})).map(g)},e[o.INTS_A]=function(t){for(var r=[],e=0;e<t.length;e++){var n=t.charCodeAt(e);r.push(g(t.substring(e+1,e+1+n))),e+=n}return r},e[o.DECIMALS]=function(t){for(var r=h(t),e=[],n=0;n<r.length;){var o=r[n++],i=v(r.slice(n,n+o));n+=o;var a=r[n++],s=v(r.slice(n,n+a));n+=a,e.push(parseFloat(i+"."+s))}return e},e[o.BOOLEANS]=function(t,r){return h(t).map((function(t){return r=t,function(t,r,e){if(e||2===arguments.length)for(var n,o=0,i=r.length;o<i;o++)!n&&o in r||(n||(n=Array.prototype.slice.call(r,0,o)),n[o]=r[o]);return t.concat(n||Array.prototype.slice.call(r))}([],Array(8),!0).map((function(t,e){return!!(r&1<<7-e)}));var r})).flat().splice(0,r)},e),S=((n={})[o.NONE]=function(t){return""},n[o.RAW]=function(t){return t.toString()},n[o.INTS_C]=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return t.map(l).join("")},n[o.INTS_D]=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var e=t.reduce((function(t,r){return Math.max(t,p(r))}),1),n=t.map((function(t){return d(t,e)})).join("");return String.fromCharCode(e)+n},n[o.INTS_A]=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return t.map((function(t){var r=p(t);return String.fromCharCode(r)+d(t,r)})).join("")},n[o.DECIMALS]=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return t.map((function(t){var r=t.toString().split("."),e=parseFloat(r[0])||0,n=r.length>1&&parseFloat(r[1])||0,o=p(e),i=p(n);return String.fromCharCode(o)+d(e,o)+String.fromCharCode(i)+d(n,i)})).join("")},n[o.BOOLEANS]=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return t(r,8).map((function(t){return String.fromCharCode(t.reduce((function(t,r,e){return t|r<<7-e}),0))})).join("")},n),m=function(){function t(t,r,e,n){this.tag=t,this.type=r,this.dataCap=e,this.dontSpread=n}return t.prototype.serialize=function(){return"".concat(this.dontSpread?1:0).concat(String.fromCharCode(this.dataCap+1)).concat(String.fromCharCode(this.type+1)).concat(String.fromCharCode(this.tag.length+1)).concat(this.tag)},t.deserialize=function(r,e){var n="1"==r[e],o=r.charCodeAt(e+1)-1,i=r.charCodeAt(e+2)-1,a=r.charCodeAt(e+3)-1;return[new t(r.substring(e+4,e+4+a),i,o,n),a]},t.deserializeAll=function(t){for(var r=[],e=0;e<t.length;){var n=this.deserialize(t,e),o=n[0],i=n[1];r.push(o),e+=4+i}return r},t}(),A=function(){function t(t){this.key=1,this.keys={},this.tags={},this.packets=t,this.packetMap={},this.createPackets(t)}return t.prototype.createKey=function(t){t.includes(",")?console.log('Tag "'.concat(t,'" is invalid; keys cannot contain commas.')):(this.keys[t]=this.key,this.tags[this.key]=t,this.key++)},t.prototype.createPackets=function(t){for(var r=0,e=t;r<e.length;r++){var n=e[r];this.createKey(n.tag),this.packetMap[n.tag]=n}},t.prototype.get=function(t){return this.keys[t]},t.prototype.getChar=function(t){return String.fromCharCode(this.get(t))},t.prototype.getPacket=function(t){return this.packetMap[t]},t.prototype.has=function(t){return null!=this.tags[t.charCodeAt(0)]},t.prototype.getKeys=function(){return this.keys},t.prototype.serialize=function(){return this.packets.map((function(t){return t.serialize()})).join("")},t.empty=function(){return new t([])},t}(),w=function(){function t(t,r){this.processor=C[t.type],this.validifier=y[t.type],this.listener=r,this.dontSpread=t.dontSpread,this.dataCap=t.dataCap}return t.prototype.listen=function(t){try{if(!this.validifier(t,this.dataCap))return!1;var r=this.processor(t,this.dataCap);return Array.isArray(r)&&!this.dontSpread?this.listener.apply(this,r):this.listener(r),!0}catch(t){return!1}},t}();function k(t,r,e){for(var n=[],o=3;o<arguments.length;o++)n[o-3]=arguments[o];var i=t.getChar(e);if(null==i)throw new Error('Tag "'.concat(e,'" has not been created!'));var a=t.getPacket(e);if(n.length>a.dataCap)throw new Error('Packet "'.concat(e,'" only allows ').concat(a.dataCap," values!"));r(i+S[a.type].apply(S,n))}var N,E,_=function(){function t(t){var r=this;this.clientPackets=A.empty(),this.serverPackets=A.empty(),this.ws=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.keyHandler=function(t){return r.serverKeyHandler(t)},this.ws.addEventListener("message",this.keyHandler),this.ws.addEventListener("close",(function(t){r.listeners.close.forEach((function(r){return r(t)}))}))}return t.prototype.serverKeyHandler=function(t){var r=this,e=t.data.toString();if(!e.startsWith("SWS"))throw this.ws.close(),new Error("The server requested is not a Sonic WS server.");var n=e.charCodeAt(3);if(0!=n)throw this.ws.close(),new Error("Version mismatch: ".concat(n>0?"client":"server"," is outdated (server: ").concat(n,", client: ").concat(0,")"));var o=e.substring(4).split(a),i=o[0],s=o[1];this.clientPackets.createPackets(m.deserializeAll(i)),this.serverPackets.createPackets(m.deserializeAll(s)),Object.keys(this.preListen).forEach((function(t){return r.preListen[t].forEach((function(e){var n=r.serverPackets.getPacket(t),o=new w(n,e);r.listen(t,o)}))})),this.ws.removeEventListener("message",this.keyHandler),this.ws.addEventListener("message",(function(t){return r.messageHandler(t)}))},t.prototype.messageHandler=function(t){var r,e=t.data.toString();if(this.listeners.message.forEach((function(t){return t(e)})),!(e.length<1)){var n=e.substring(0,1),o=e.substring(1),i=n.charCodeAt(0);null!=i&&(null===(r=this.listeners.event[i])||void 0===r||r.forEach((function(t){return t.listen(o)})))}},t.prototype.listen=function(t,r){var e=this.serverPackets.get(t);e?(this.listeners.event[e]||(this.listeners.event[e]=[]),this.listeners.event[e].push(r)):console.log("Key is not available on server: "+t)},t.prototype.raw_onmessage=function(t){this.listeners.message.push(t)},t.prototype.raw_send=function(t){this.ws.send(t)},t.prototype.send=function(t){for(var r=this,e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];k.apply(void 0,function(t,r,e){if(e||2===arguments.length)for(var n,o=0,i=r.length;o<i;o++)!n&&o in r||(n||(n=Array.prototype.slice.call(r,0,o)),n[o]=r[o]);return t.concat(n||Array.prototype.slice.call(r))}([this.clientPackets,function(t){return r.raw_send(t)},t],e,!1))},t.prototype.on_ready=function(t){this.ws.readyState===WebSocket.OPEN?t():this.ws.addEventListener("open",t)},t.prototype.on_close=function(t){this.listeners.close.push(t)},t.prototype.on=function(t,r){if(this.ws.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(r);var e=this.serverPackets.getPacket(t),n=new w(e,r);this.listen(t,n)},t}(),T=(N=function(t,r){return N=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])},N(t,r)},function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function e(){this.constructor=t}N(t,r),t.prototype=null===r?Object.create(r):(e.prototype=r.prototype,new e)});window.SonicWS=((E=function(t){function r(r,e){var n=new WebSocket(r,e);return t.call(this,n)||this}return T(r,t),r}(_)).PacketType=o,E)})();