(()=>{"use strict";const t={string:0,number:1,boolean:2,undefined:3,object:4},e={0:t=>t,1:t=>parseFloat(t),2:t=>"true"==t,3:()=>{},4:()=>null};class r{constructor(t,e){this.tag=t,this.values=e}serialize(){return String.fromCharCode(this.tag.length+1)+this.tag+String.fromCharCode(this.values.length+1)+this.values.map((e=>String.fromCharCode(String(e).length+1)+String.fromCharCode(function(e){const r=typeof e;if(!(r in t)&&null!=e)throw new Error(`Cannot serialize type "${r}" in an enum!`);return t[r]}(e)+1)+e)).join("")}}const s={},n={};function i(t,e){if(e.length>128)throw new Error("An enum can only hold 128 possible values.");return s[t]=Object.fromEntries(e.map(((t,e)=>[t,e]))),n[t]=Object.fromEntries(e.map(((t,e)=>[e,t]))),new r(t,e)}const a=String.fromCharCode(0),o=String.fromCharCode(1),h=String.fromCharCode(2),l=Number.MAX_SAFE_INTEGER,c=Math.floor(27647.5),u=c+1,d=[];function g(t){var e;return null!==(e=d[t])&&void 0!==e?e:d[t]=Math.pow(u,t)}const m=[];function f(t){var e;return null!==(e=m[t])&&void 0!==e?e:m[t]=Math.pow(10,t)}for(let t=1;t<=3;t++)g(t),f(t);function p(t){return Array.from(t,(t=>t.charCodeAt(0)))}function S(t){return t<=c?t:-t+c}function C(t){if(!isFinite(t))throw new Error("Cannot use NaN or Infinity in INT_C");if(t>c||t<-c-1)throw new Error(`INT_C Numbers must be within range -${c+1} and ${c}`);return String.fromCharCode(function(t){return t<0?-t+c:t}(t))}function y(t){t=Math.abs(t);let e=1;for(let r=g(1);t>=r;r=g(++e));return e}function E(t,e){if(!isFinite(t))throw new Error("Cannot use a non-finite number in INT_E: "+t);if(0==t)return a;const r=t<0;if((t=Math.abs(t))>l)throw new Error(`INT_D Numbers must be within range -${l.toLocaleString()} and ${l.toLocaleString()}: ${t}`);let s=[];const n=e-1;for(let e=0;e<n;e++){const r=g(n-e),i=Math.floor(t/r);s.push(i),t-=i*r}return s.push(t%u),r?s.map((t=>String.fromCharCode(t>0?t+c:t))).join(""):String.fromCharCode(...s)}function N(t){return v(p(t))}function v(t){return t.reduce(((t,e,r,s)=>t+S(e)*g(s.length-r-1)),0)}function w(t){return t>=0?t:Math.abs(t)+512}function A(t){const e=function(t){return t>512?-(t-512):t}(t.charCodeAt(0)),r=N(t.substring(1));return r*f(e-String(r).length+1)}function b(t,e){const r=[];for(let s=0;s<t.length;s+=e)r.push(t.slice(s,s+e));return r}var M,T;new TextEncoder,(T=M||(M={}))[T.NONE=0]="NONE",T[T.RAW=1]="RAW",T[T.STRINGS=2]="STRINGS",T[T.ENUMS=3]="ENUMS",T[T.INTS_C=4]="INTS_C",T[T.UINTS_C=5]="UINTS_C",T[T.INTS_D=6]="INTS_D",T[T.INTS_A=7]="INTS_A",T[T.EXPONENTIAL=8]="EXPONENTIAL",T[T.DECIMALS=9]="DECIMALS",T[T.BOOLEANS=10]="BOOLEANS";const k=(t,e,r)=>{let s=0;for(let r=0;r<t.length;r++){if(s++,s>e)return!1;if(r+=t.charCodeAt(r),r+1>t.length)return!1}return!(s<r)},I=(t,e,r)=>t.length>=r&&t.length<=e,L=(t,e,r,s)=>{if(0==t.length)return!1;const n=t.length-1,i=t.charCodeAt(0)+s;if(n%i!=0)return!1;const a=n/i;return!(a<r||a>e)},P={[M.NONE]:t=>0==t.length,[M.RAW]:()=>!0,[M.STRINGS]:k,[M.ENUMS]:(t,e,r,s,n)=>{if(t.length<r||t.length>e||n>=s.enumData.length)return!1;const i=s.enumData[n];for(let e=0;e<t.length;e++)if(i.values.length<=t.charCodeAt(e))return!1;return!0},[M.INTS_C]:I,[M.UINTS_C]:I,[M.INTS_D]:(t,e,r)=>L(t,e,r,0),[M.INTS_A]:k,[M.EXPONENTIAL]:(t,e,r)=>L(t,e,r,1),[M.DECIMALS]:(t,e,r)=>{let s=0;for(let r=0;r<t.length;){if(s++,s>e)return!1;const n=t.charCodeAt(r++),i=127&n;if(r+=n>>7,r>t.length)return!1;if(r+=i,r>t.length)return!1}return!(s<r)},[M.BOOLEANS]:(t,e,r)=>{const s=p(t);return s.length>=Math.floor(r/8)+1&&s.length<=Math.floor(e/8)+1&&null==s.find((t=>t>255))}},_={[M.NONE]:t=>"",[M.RAW]:t=>t,[M.STRINGS]:t=>{let e=[];for(let r=0;r<t.length;r++){const s=t.charCodeAt(r);e.push(t.substring(r+1,r+1+s)),r+=s}return e},[M.ENUMS]:(t,e,r,s)=>{const n=r.enumData[s];return p(t).map((t=>n.values[t]))},[M.INTS_C]:t=>p(t).map(S),[M.UINTS_C]:t=>p(t),[M.INTS_D]:t=>b(t.substring(1),t.charCodeAt(0)).map(N),[M.INTS_A]:t=>{let e=[];for(let r=0;r<t.length;r++){const s=t.charCodeAt(r);e.push(N(t.substring(r+1,r+1+s))),r+=s}return e},[M.EXPONENTIAL]:t=>b(t.substring(1),t.charCodeAt(0)+1).map(A),[M.DECIMALS]:t=>{const e=p(t);let r=[];for(let t=0;t<e.length;){const s=e[t++],n=s>>7,i=127&s,a=v(e.slice(t,t+n));t+=n;const o=v(e.slice(t,t+i));t+=i,r.push(parseFloat(a+"."+o))}return r},[M.BOOLEANS]:(t,e)=>p(t).map((t=>{return e=t,[...Array(7)].map(((t,r)=>!!(e&1<<6-r)));var e})).flat().splice(0,e)},x={[M.NONE]:t=>"",[M.RAW]:t=>t.toString(),[M.STRINGS]:(...t)=>t.map((t=>String.fromCharCode(t.toString().length)+t)).join(""),[M.ENUMS]:(...t)=>t.join(""),[M.INTS_C]:(...t)=>t.map(C).join(""),[M.UINTS_C]:(...t)=>String.fromCharCode(...t),[M.INTS_D]:(...t)=>{const e=t.reduce(((t,e)=>Math.max(t,y(e))),1),r=t.map((t=>E(t,e).padStart(e,a)));return String.fromCharCode(e)+r.join("")},[M.INTS_A]:(...t)=>t.map((t=>{const e=y(t);return String.fromCharCode(e)+E(t,e)})).join(""),[M.EXPONENTIAL]:(...t)=>function(t){const e=t.map((t=>{if(!isFinite(t))throw new Error("Cannot use a non-finite number in INT_E: "+t);if(0==t)return[0,0];const[e,r]=t.toExponential().split("e").map(Number),s=+String(e).replace(".","").substring(0,15),n=s<0?1:0;return[s,w(r)+(r<0?-n:n)]})),r=e.reduce(((t,e)=>Math.max(t,y(e[0]))),1)+1;return String.fromCharCode(r)+e.map((([t,e])=>String.fromCharCode(e)+E(t,r).padStart(r,a))).join("")}(t),[M.DECIMALS]:(...t)=>t.map((t=>{const e=t.toString().split("."),r=parseFloat(e[0])||0,s=e.length>1&&parseFloat(e[1])||0,n=y(r),i=y(s),a=n<<7|i;return String.fromCharCode(a)+E(r,n)+E(s,i)})).join(""),[M.BOOLEANS]:(...t)=>b(t,7).map((t=>String.fromCharCode(t.reduce(((t,e,r)=>t|e<<6-r),0)))).join("")};class O{constructor(t,e,r,s){this.tag=t,e.object?(this.type=e.types,this.dataMax=e.dataMaxes,this.dataMin=e.dataMins,this.maxSize=this.type.length,this.minSize=this.type.length,this.object=!0,this.receiveProcessor=function(t){const e=t.map((t=>_[t]));return(r,s,n)=>{let i=[],a=0;for(let o=0;o<r.length;){const h=r.charCodeAt(o++),l=r.substring(o,o+h);i.push(e[i.length](l,s[i.length],n,t[i.length]==M.ENUMS?a++:0)),o+=h}return i}}(this.type),this.validifier=function(t){const e=t.map((t=>P[t]));return(r,s,n,i)=>{let a=0,o=0;for(let h=0;h<r.length;){const l=r.charCodeAt(h++);if(l+h>r.length)return!1;const c=r.slice(h,h+=l);if(!e[a](c,s[a],n[a],i,t[a]==M.ENUMS?o++:0))return!1;if(++a>s.length)return!1}return!0}}(this.type),this.sendProcessor=function(t){const e=t.length,r=t.map((t=>x[t]));return(...t)=>{let s="";for(let n=0;n<e;n++){const e=r[n](...t[n]);s+=String.fromCharCode(e.length)+e}return s}}(this.type)):(this.type=e.type,this.dataMax=e.dataMax,this.dataMin=e.dataMin,this.maxSize=this.dataMax,this.minSize=this.dataMin,this.object=!1,this.receiveProcessor=_[this.type],this.validifier=P[this.type],this.sendProcessor=x[this.type]),this.processReceive=t=>this.receiveProcessor(t,this.dataMax,this,0),this.processSend=(...t)=>this.sendProcessor(...t.flat()),this.validate=s?()=>!0:t=>this.validifier(t,this.dataMax,this.dataMin,this,0),this.customValidator=r,this.enumData=e.enumData,this.dontSpread=e.dontSpread,this.autoFlatten=e.autoFlatten}listen(t){try{const e=process.hrtime.bigint();if(!this.validate(t))return"Invalid packet";const r=this.processReceive(t),s=Array.isArray(r)&&!this.dontSpread,n=this.autoFlatten?$(r):r;if(null!=this.customValidator)if(s){if(!this.customValidator(...n))return"Didn't pass custom validator"}else if(!this.customValidator(n))return"Didn't pass custom validator";return console.log("Receive processing time: "+Number(process.hrtime.bigint()-e)/1e6+"ms"),[n,s]}catch(t){return console.error("There was an error processing the packet! This is probably my fault... report at https://github.com/cutelittlelily/sonic-ws",t),"Error: "+t}}serialize(){const t=this.dontSpread?h:o,e=String.fromCharCode(this.enumData.length+1)+this.enumData.map((t=>t.serialize())).join("");return this.object?t+e+String.fromCharCode(this.maxSize+2)+(this.autoFlatten?h:o)+String.fromCharCode(...this.dataMax.map((t=>t+1)))+String.fromCharCode(...this.dataMin.map((t=>t+1)))+String.fromCharCode(...this.type.map((t=>t+1)))+String.fromCharCode(this.tag.length+1)+this.tag:t+e+o+String.fromCharCode(this.dataMax+1)+String.fromCharCode(this.dataMin+1)+String.fromCharCode(this.type+1)+String.fromCharCode(this.tag.length+1)+this.tag}static deserialize(t,r,s){const n=r,a=t[r]==h,o=t.charCodeAt(++r)-1,l=[];for(let s=0;s<o;s++){const s=t.charCodeAt(++r)-1,n=t.slice(++r,r+=s);r--;const a=t.charCodeAt(++r)-1,o=[];for(let s=0;s<a;s++){const s=t.charCodeAt(++r)-1,n=t.charCodeAt(++r)-1,i=t.slice(++r,r+=s);r--,o.push(e[n](i))}l.push(i(n,o))}const c=t.charCodeAt(++r)-2;if(-1!=c){const e=t[++r]==h,i=++r,o=i+c,u=o,d=u+c,g=d,m=g+c,f=m+1,S=p(t.substring(i,o)).map((t=>t-1)),C=p(t.substring(u,d)).map((t=>t-1)),y=p(t.substring(g,m)).map((t=>t-1));let E=0;const N=y.map((t=>t==M.ENUMS?l[E++]:t)),v=t.charCodeAt(f-1)-1,w=t.substring(f,f+v);return[new O(w,j.object(N,S,C,a,e),null,s),r-n+1+c+c+c+v]}const u=t.charCodeAt(++r)-1,d=t.charCodeAt(++r)-1,g=t.charCodeAt(++r)-1,m=g==M.ENUMS?l[0]:g,f=++r,S=t.charCodeAt(f)-1,C=t.substring(f+1,f+1+S);return[new O(C,j.single(m,u,d,a),null,s),r-n+1+S]}static deserializeAll(t,e){const r=[];let s=0;for(;s<t.length;){const[n,i]=this.deserialize(t,s,e);r.push(n),s+=i}return r}}class j{constructor(t){this.types=[],this.dataMaxes=[],this.dataMins=[],this.type=M.NONE,this.dataMax=-1,this.dataMin=-1,this.enumData=[],this.dontSpread=!1,this.autoFlatten=!1,this.object=t}static single(t,e,r,s){const n=new j(!1);return"number"==typeof t?n.type=t:(n.type=M.ENUMS,n.enumData=[t]),n.dataMax=e,n.dataMin=r,n.dontSpread=s,n}static object(t,e,r,s,n){if(t.length!=e.length||t.length!=r.length)throw new Error("There is an inbalance between the amount of types, data maxes, and data mins!");const i=new j(!0);return t.forEach((t=>{"number"==typeof t?i.types.push(t):(i.types.push(M.ENUMS),i.enumData.push(t))})),i.dataMaxes=e,i.dataMins=r,i.dontSpread=s,i.autoFlatten=n,i}}function D(t){var e,r;return null!==(r=null===(e=t[0])||void 0===e?void 0:e.map(((e,r)=>t.map((t=>t[r])))))&&void 0!==r?r:[]}function $(t){var e,r;return null!==(r=null===(e=t[0])||void 0===e?void 0:e.map(((e,r)=>t.map((t=>t[r])))))&&void 0!==r?r:[]}class z{constructor(t){this.key=1,this.keys={},this.tags={},this.packets=t,this.packetMap={},this.createPackets(t)}createKey(t){this.keys[t]=this.key,this.tags[this.key]=t,this.key++}createPackets(t){for(const e of t)this.createKey(e.tag),this.packetMap[e.tag]=e}get(t){return this.keys[t]}getChar(t){return String.fromCharCode(this.get(t))}getTag(t){return this.tags[t.charCodeAt(0)]}getPacket(t){return this.packetMap[t]}has(t){return t.charCodeAt(0)in this.tags}hasTag(t){return t in this.keys}getKeys(){return this.keys}getTags(){return this.tags}serialize(){return this.packets.map((t=>t.serialize())).join("")}static empty(){return new z([])}}String.fromCharCode(5);class F{constructor(t){this.clientPackets=z.empty(),this.serverPackets=z.empty(),this.pastKeys=!1,this.readyListeners=[],this.rateLimitTimeout=-1,this.rateLimit=-1,this.sentPackets=0,this.sendQueue=[],this.ws=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.keyHandler=t=>this.serverKeyHandler(t),this.ws.addEventListener("message",this.keyHandler),this.ws.addEventListener("close",(t=>{this.listeners.close.forEach((e=>e(t))),0!=this.rateLimit&&-1!=this.rateLimitTimeout&&clearInterval(this.rateLimitTimeout)}))}serverKeyHandler(t){const e=t.data.toString();if(!e.startsWith("SWS"))throw this.ws.close(1003),new Error("The server requested is not a Sonic WS server.");const r=e.charCodeAt(3);if(5!=r)throw this.ws.close(1003),new Error(`Version mismatch: ${r>5?"client":"server"} is outdated (server: ${r}, client: 5)`);const[s,n,i]=e.substring(4).split(a);this.clientPackets.createPackets(O.deserializeAll(s,!0)),this.serverPackets.createPackets(O.deserializeAll(n,!0)),this.rateLimit=i.charCodeAt(0),0!=this.rateLimit&&(this.rateLimitTimeout=setInterval((()=>{this.sentPackets=0;const t=[...this.sendQueue];this.sendQueue=[],t.forEach((t=>this.raw_send(t)))}),1e3)),Object.keys(this.preListen).forEach((t=>this.preListen[t].forEach((e=>{if(null==this.serverPackets.get(t))return console.error(new Error(`The server does not send the packet with tag "${t}"!`));this.listen(t,e)})))),this.preListen=null,this.pastKeys=!0,this.readyListeners.forEach((t=>t())),this.readyListeners=null,this.ws.removeEventListener("message",this.keyHandler),this.ws.addEventListener("message",(t=>this.messageHandler(t))),this.keyHandler=null}messageHandler(t){var e,r;let s=t.data.toString();if(this.listeners.message.forEach((t=>t(s))),s.length<1)return;const n=s.substring(0,1),i=s.substring(1),a=n.charCodeAt(0);if(null==a)return;const o=this.serverPackets.getPacket(this.serverPackets.getTag(n)).listen(i);if("string"==typeof o)throw console.log(o),new Error("An error occured with data from the server!! This is probably my fault.. make an issue at https://github.com/cutelittlelily/sonic-ws");const[h,l]=o;l?null===(e=this.listeners.event[a])||void 0===e||e.forEach((t=>t(...h))):null===(r=this.listeners.event[a])||void 0===r||r.forEach((t=>t(h)))}listen(t,e){const r=this.serverPackets.get(t);r?(this.listeners.event[r]||(this.listeners.event[r]=[]),this.listeners.event[r].push(e)):console.log("Key is not available on server: "+t)}raw_onmessage(t){this.listeners.message.push(t)}raw_send(t){return-1==this.rateLimit?console.error("A rate limit has not been received by the server!"):0!=this.rateLimit&&++this.sentPackets>this.rateLimit?(this.sendQueue.push(t),console.warn(`Client is emitting more packets than the rate limit! Current queue size: ${this.sendQueue.length}`)):void this.ws.send(t)}send(t,...e){!function(t,e,r,s){const n=process.hrtime.bigint(),i=t.getChar(r);if(i==a)throw new Error(`Tag "${r}" has not been created!`);const o=t.getPacket(r);if(o.autoFlatten)s=D(s[0]);else{if(s.length>o.maxSize)throw new Error(`Packet "${r}" only allows ${o.maxSize} values!`);if(s.length<o.minSize)throw new Error(`Packet "${r}" requires at least ${o.minSize} values!`)}if(o.object){s=s.map((t=>Array.isArray(t)?t:[t]));const t=o.dataMin,e=o.dataMax;for(let n=0;n<t.length;n++){if(s[n].length<t[n])throw new Error(`Section ${n+1} of packet "${r}" requires at least ${t[n]} values!`);if(s[n].length>e[n])throw new Error(`Section ${n+1} of packet "${r}" only allows ${e[n]} values!`)}}else{const t=s.find((t=>"object"==typeof t&&null!=t));t&&console.warn(`Passing an array will result in undefined behavior (${JSON.stringify(t)}). Spread the array with ...arr`)}e(i+(s.length>0?o.processSend(s):"")),console.log("Send processing time: "+Number(process.hrtime.bigint()-n)/1e6+"ms")}(this.clientPackets,(t=>this.raw_send(t)),t,e)}on_ready(t){this.pastKeys?t():this.readyListeners.push(t)}on_close(t){this.listeners.close.push(t)}on(t,e){if(this.ws.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(e);this.serverPackets.getPacket(t),this.listen(t,e)}}window.SonicWS=class extends F{constructor(t,e){super(new WebSocket(t,e))}WrapEnum(t,e){return function(t,e){if(!(e in s[t]))throw new Error(`Value "${e}" does not exist in enum "${t}"`);return String.fromCharCode(s[t][e])}(t,e)}FlattenData(t){return D(t)}UnFlattenData(t){return $(t)}}})();