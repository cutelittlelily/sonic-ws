/*!
 * SonicWS
 * (c) 2025 Lily (cutelittlelily)
 * Released under the Apache-2.0 License
 * https://www.apache.org/licenses/LICENSE-2.0
 */
(()=>{"use strict";const t={string:0,number:1,boolean:2,undefined:3,object:4},e={0:t=>t,1:t=>parseFloat(t),2:t=>"true"==t,3:()=>{},4:()=>null};class r{constructor(t,e){this.tag=t,this.values=e}serialize(){return String.fromCharCode(this.tag.length+1)+this.tag+String.fromCharCode(this.values.length+1)+this.values.map((e=>String.fromCharCode(String(e).length+1)+String.fromCharCode(function(e){const r=typeof e;if(!(r in t)&&null!=e)throw new Error(`Cannot serialize type "${r}" in an enum!`);return t[r]}(e)+1)+e)).join("")}}const i={},s={};function n(t,e){if(e.length>128)throw new Error("An enum can only hold 128 possible values.");return i[t]=Object.fromEntries(e.map(((t,e)=>[t,e]))),s[t]=Object.fromEntries(e.map(((t,e)=>[e,t]))),new r(t,e)}function a(t,e){const r=[];for(let i=0;i<t.length;i+=e)r.push(t.slice(i,i+e));return r}const o=String.fromCharCode(0),h=String.fromCharCode(1),c=String.fromCharCode(2),l=Number.MAX_SAFE_INTEGER,u=Math.floor(27647.5),d=u+1,g=[];function f(t){var e;return null!==(e=g[t])&&void 0!==e?e:g[t]=Math.pow(d,t)}const m=[];function p(t){var e;return null!==(e=m[t])&&void 0!==e?e:m[t]=Math.pow(10,t)}for(let t=0;t<=3;t++)f(t),p(t);function S(t){return Array.from(t,(t=>t.charCodeAt(0)))}function C(t){return t<=u?t:-t+u}function k(t){if(!isFinite(t))throw new Error("Cannot use NaN or Infinity in INT_C");if(t>u||t<-u-1)throw new Error(`INT_C Numbers must be within range -${u+1} and ${u}`);return String.fromCharCode(function(t){return t<0?-t+u:t}(t))}function E(t){t=Math.abs(t);let e=1;for(let r=f(1);t>=r;r=f(++e));return e}function N(t,e){if(!isFinite(t))throw new Error("Cannot use a non-finite number in INT_E: "+t);if(0==t)return o.repeat(e);if(1==e)return k(t);const r=t<0;if((t=Math.abs(t))>l)throw new Error(`INT_D Numbers must be within range -${l.toLocaleString()} and ${l.toLocaleString()}: ${t}`);let i=[];const s=e-1;for(let e=0;e<s;e++){const r=f(s-e),n=Math.floor(t/r);i.push(n),t-=n*r}i.push(t%d);return r?i.map((t=>String.fromCharCode(t>0?t+u:t))).join(""):String.fromCharCode(...i)}function y(t){return v(S(t))}function v(t){return 0==t.length?C(t[0]):t.reduce(((t,e,r,i)=>t+C(e)*f(i.length-r-1)),0)}function b(t){return t>=0?t:Math.abs(t)+512}function A(t){const e=function(t){return t>512?-(t-512):t}(t.charCodeAt(0)),r=y(t.substring(1));return r*p(e-String(r).length+1)}function w(t){return t<<1^t>>15}function T(t){return t>>>1^-(1&t)}new TextEncoder;var M;!function(t){t[t.NONE=0]="NONE",t[t.RAW=1]="RAW",t[t.STRINGS=2]="STRINGS",t[t.ENUMS=3]="ENUMS",t[t.INTS_C=4]="INTS_C",t[t.UINTS_C=5]="UINTS_C",t[t.ZIG_ZAG=6]="ZIG_ZAG",t[t.INTS_D=7]="INTS_D",t[t.INTS_A=8]="INTS_A",t[t.EXPONENTIAL=9]="EXPONENTIAL",t[t.DECIMALS=10]="DECIMALS",t[t.BOOLEANS=11]="BOOLEANS"}(M||(M={}));const I=(t,e,r)=>{let i=0;for(let r=0;r<t.length;r++){if(i++,i>e)return!1;if(r+=t.charCodeAt(r),r+1>t.length)return!1}return!(i<r)},D=(t,e,r)=>t.length>=r&&t.length<=e&&null==S(t).find((t=>t>55295)),P=(t,e,r,i)=>{if(0==t.length)return!1;const s=t.length-1,n=t.charCodeAt(0)+i;if(s%n!=0)return!1;const a=s/n;return!(a<r||a>e)},_={[M.NONE]:t=>0==t.length,[M.RAW]:()=>!0,[M.STRINGS]:I,[M.ENUMS]:(t,e,r,i,s)=>{if(t.length<r||t.length>e||s>=i.enumData.length)return!1;const n=i.enumData[s];for(let e=0;e<t.length;e++)if(n.values.length<=t.charCodeAt(e))return!1;return!0},[M.INTS_C]:D,[M.UINTS_C]:D,[M.ZIG_ZAG]:D,[M.INTS_D]:(t,e,r)=>P(t,e,r,0),[M.INTS_A]:I,[M.EXPONENTIAL]:(t,e,r)=>P(t,e,r,1),[M.DECIMALS]:(t,e,r)=>{let i=0;for(let r=0;r<t.length;){if(i++,i>e)return!1;const s=t.charCodeAt(r++),n=127&s;if(r+=s>>7,r>t.length)return!1;if(r+=n,r>t.length)return!1}return!(i<r)},[M.BOOLEANS]:(t,e,r)=>{const i=S(t);return i.length>=Math.floor(r/8)+1&&i.length<=Math.floor(e/8)+1&&null==i.find((t=>t>255))}},z={[M.NONE]:t=>"",[M.RAW]:t=>t,[M.STRINGS]:t=>{let e=[];for(let r=0;r<t.length;r++){const i=t.charCodeAt(r);e.push(t.substring(r+1,r+1+i)),r+=i}return e},[M.ENUMS]:(t,e,r,i)=>{const s=r.enumData[i];return S(t).map((t=>s.values[t]))},[M.INTS_C]:t=>S(t).map(C),[M.UINTS_C]:t=>S(t),[M.ZIG_ZAG]:t=>S(t).map(T),[M.INTS_D]:t=>a(t.substring(1),t.charCodeAt(0)).map(y),[M.INTS_A]:t=>{let e=[];for(let r=0;r<t.length;r++){const i=t.charCodeAt(r);e.push(y(t.substring(r+1,r+1+i))),r+=i}return e},[M.EXPONENTIAL]:t=>a(t.substring(1),t.charCodeAt(0)+1).map(A),[M.DECIMALS]:t=>{const e=S(t);let r=[];for(let t=0;t<e.length;){const i=e[t++],s=i>>7,n=127&i,a=v(e.slice(t,t+s));t+=s;const o=v(e.slice(t,t+n));t+=n,r.push(parseFloat(a+"."+o))}return r},[M.BOOLEANS]:(t,e)=>S(t).map((t=>{return e=t,[...Array(7)].map(((t,r)=>!!(e&1<<6-r)));var e})).flat().splice(0,e)},L={[M.NONE]:()=>"",[M.RAW]:t=>t.map(String).join(""),[M.STRINGS]:t=>t.map((t=>String.fromCharCode(t.toString().length)+t)).join(""),[M.ENUMS]:t=>t.join(""),[M.INTS_C]:t=>t.map(k).join(""),[M.UINTS_C]:t=>String.fromCharCode(...t),[M.ZIG_ZAG]:t=>String.fromCharCode(...t.map(w)),[M.INTS_D]:t=>{const e=t.reduce(((t,e)=>Math.max(t,E(e))),1),r=t.map((t=>N(t,e)));return String.fromCharCode(e)+r.join("")},[M.INTS_A]:t=>t.map((t=>{const e=E(t);return String.fromCharCode(e)+N(t,e)})).join(""),[M.EXPONENTIAL]:t=>function(t){const e=t.map((t=>{if(!isFinite(t))throw new Error("Cannot use a non-finite number in INT_E: "+t);if(0==t)return[0,0];const[e,r]=t.toExponential().split("e").map(Number),i=+String(e).replace(".","").substring(0,15),s=i<0?1:0;return[i,b(r)+(r<0?-s:s)]})),r=e.reduce(((t,e)=>Math.max(t,E(e[0]))),1)+1;return String.fromCharCode(r)+e.map((([t,e])=>String.fromCharCode(e)+N(t,r))).join("")}(t),[M.DECIMALS]:t=>t.map((t=>{const e=t.toString().split("."),r=parseFloat(e[0])||0,i=e.length>1&&parseFloat(e[1])||0,s=E(r),n=E(i),a=s<<7|n;return String.fromCharCode(a)+N(r,s)+N(i,n)})).join(""),[M.BOOLEANS]:t=>a(t,7).map((t=>String.fromCharCode(t.reduce(((t,e,r)=>t|e<<6-r),0)))).join("")};class x{constructor(t,e,r,i,s){this.tag=t,this.defaultEnabled=i,this.enumData=e.enumData,this.rateLimit=e.rateLimit,this.dontSpread=e.dontSpread,this.autoFlatten=e.autoFlatten,this.dataBatching=e.dataBatching,this.maxBatchSize=s?1/0:e.maxBatchSize,this.packetDelimitSize=e.packetDelimitSize,e.object?(this.type=e.types,this.dataMax=e.dataMaxes,this.dataMin=e.dataMins,this.maxSize=this.type.length,this.minSize=this.type.length,this.object=!0,this.receiveProcessor=function(t,e){const r=t.map((t=>z[t]));return(i,s,n)=>{let a=[],o=0;for(let h=0;h<i.length;){const c=y(i.slice(h,h+=e)),l=i.slice(h,h+=c);a.push(r[a.length](l,s[a.length],n,t[a.length]==M.ENUMS?o++:0))}return a}}(this.type,this.packetDelimitSize),this.validifier=function(t,e){const r=t.map((t=>_[t]));return(i,s,n,a)=>{let o=0,h=0;for(let c=0;c<i.length;){const l=y(i.slice(c,c+=e));if(l+c>i.length)return!1;const u=i.slice(c,c+=l);if(!r[o](u,s[o],n[o],a,t[o]==M.ENUMS?h++:0))return!1;if(++o>s.length)return!1}return!0}}(this.type,this.packetDelimitSize),this.sendProcessor=function(t,e){const r=t.length,i=t.map((t=>L[t]));return t=>{let s="";for(let n=0;n<r;n++){const r=t[n],a=i[n](Array.isArray(r)?r:[r]);if(a.length>f(e))throw new Error(`Cannot store ${a.length} bytes of data! Set largePacket: true on the object!`);s+=N(a.length,e)+a}return s}}(this.type,this.packetDelimitSize)):(this.type=e.type,this.dataMax=e.dataMax,this.dataMin=e.dataMin,this.maxSize=this.dataMax,this.minSize=this.dataMin,this.object=!1,this.receiveProcessor=z[this.type],this.validifier=_[this.type],this.sendProcessor=L[this.type]),this.processReceive=t=>this.receiveProcessor(t,this.dataMax,this,0),this.processSend=t=>this.sendProcessor(t),this.validate=s?()=>!0:t=>this.validifier(t,this.dataMax,this.dataMin,this,0),this.customValidator=r}listen(t,e){try{if(!this.validate(t))return"Invalid packet";const r=this.processReceive(t),i=this.autoFlatten?O(r):r;if(null!=this.customValidator)if(this.dontSpread){if(!this.customValidator(e,i))return"Didn't pass custom validator"}else if(!this.customValidator(e,...i))return"Didn't pass custom validator";return[i,!this.dontSpread]}catch(t){return console.error("There was an error processing the packet! This is probably my fault... report at https://github.com/cutelittlelily/sonic-ws",t),"Error: "+t}}serializeINT_D(t){return String.fromCharCode(...S(N(t,this.packetDelimitSize)).map((t=>t+1)))}serialize(){const t=this.dontSpread?c:h,e=String.fromCharCode(this.enumData.length+1)+this.enumData.map((t=>t.serialize())).join(""),r=String.fromCharCode(this.dataBatching+1)+String.fromCharCode(this.maxBatchSize+1),i=String.fromCharCode(this.rateLimit+1);return this.object?t+r+i+e+String.fromCharCode(this.maxSize+2)+(this.autoFlatten?c:h)+String.fromCharCode(this.packetDelimitSize+1)+this.dataMax.map((t=>this.serializeINT_D(t))).join("")+this.dataMin.map((t=>this.serializeINT_D(t))).join("")+this.type.map((t=>String.fromCharCode(t+1))).join("")+String.fromCharCode(this.tag.length+1)+this.tag:t+r+i+e+h+String.fromCharCode(this.dataMax+1)+String.fromCharCode(this.dataMin+1)+String.fromCharCode(this.type+1)+String.fromCharCode(this.tag.length+1)+this.tag}static processINT_Ds(t,e){return a(S(t),e).map((t=>v(t.map((t=>t-1)))))}static deserialize(t,r,i){const s=r,a=t[r]==c,o=t.charCodeAt(++r)-1,h=t.charCodeAt(++r)-1,l=t.charCodeAt(++r)-1,u=t.charCodeAt(++r)-1,d=[];for(let i=0;i<u;i++){const i=t.charCodeAt(++r)-1,s=t.slice(++r,r+=i);r--;const a=t.charCodeAt(++r)-1,o=[];for(let i=0;i<a;i++){const i=t.charCodeAt(++r)-1,s=t.charCodeAt(++r)-1,n=t.slice(++r,r+=i);r--,o.push(e[s](n))}d.push(n(s,o))}const g=t.charCodeAt(++r)-2;if(-1!=g){const e=t[++r]==c,n=t.charCodeAt(++r)-1,u=g*n,f=++r,m=f+u,p=m,C=p+u,k=C,E=k+g,N=E+1,y=this.processINT_Ds(t.substring(f,m),n),v=this.processINT_Ds(t.substring(p,C),n),b=S(t.substring(k,E)).map((t=>t-1));let A=0;const w=b.map((t=>t==M.ENUMS?d[A++]:t)),T=t.charCodeAt(N-1)-1,I=t.substring(N,N+T),D=j.object(w,y,v,a,e,n,o,h,l);return[new x(I,D,null,!1,i),r-s+1+u+u+g+T]}const f=t.charCodeAt(++r)-1,m=t.charCodeAt(++r)-1,p=t.charCodeAt(++r)-1,C=p==M.ENUMS?d[0]:p,k=++r,E=t.charCodeAt(k)-1,N=t.substring(k+1,k+1+E),y=j.single(C,f,m,a,o,h,l);return[new x(N,y,null,!1,i),r-s+1+E]}static deserializeAll(t,e){const r=[];let i=0;for(;i<t.length;){const[s,n]=this.deserialize(t,i,e);r.push(s),i+=n}return r}}class j{constructor(t){this.types=[],this.dataMaxes=[],this.dataMins=[],this.type=M.NONE,this.dataMax=-1,this.dataMin=-1,this.packetDelimitSize=1,this.dataBatching=0,this.maxBatchSize=10,this.rateLimit=0,this.enumData=[],this.dontSpread=!1,this.autoFlatten=!1,this.object=t}static single(t,e,r,i,s,n,a){const o=new j(!1);return"number"==typeof t?o.type=t:(o.type=M.ENUMS,o.enumData=[t]),o.dataMax=e,o.dataMin=r,o.dontSpread=i,o.dataBatching=s,o.maxBatchSize=n,o.rateLimit=a,o}static object(t,e,r,i,s,n,a,o,h){if(t.length!=e.length||t.length!=r.length)throw new Error("There is an inbalance between the amount of types, data maxes, and data mins!");const c=new j(!0);return t.forEach((t=>{"number"==typeof t?c.types.push(t):(c.types.push(M.ENUMS),c.enumData.push(t))})),c.dataMaxes=e,c.dataMins=r,c.dontSpread=i,c.autoFlatten=s,c.packetDelimitSize=n,c.dataBatching=a,c.maxBatchSize=o,c.rateLimit=h,c}}function B(t){var e,r;return null!==(r=null===(e=t[0])||void 0===e?void 0:e.map(((e,r)=>t.map((t=>t[r])))))&&void 0!==r?r:[]}function O(t){var e,r;return null!==(r=null===(e=t[0])||void 0===e?void 0:e.map(((e,r)=>t.map((t=>t[r])))))&&void 0!==r?r:[]}class ${constructor(t){this.key=1,this.keys={},this.tags={},this.packetMap={},t&&(this.packets=t,this.holdPackets(t))}createKey(t){this.keys[t]=this.key,this.tags[this.key]=t,this.key++}holdPackets(t){for(const e of t)this.createKey(e.tag),this.packetMap[e.tag]=e}get(t){return this.keys[t]}getChar(t){return String.fromCharCode(this.get(t))}getTag(t){return this.tags[t.charCodeAt(0)]}getPacket(t){if(!(t in this.packetMap))throw new Error("Unknown packet tag: "+t);return this.packetMap[t]}has(t){return t.charCodeAt(0)in this.tags}hasTag(t){return t in this.keys}getKeys(){return this.keys}getTagMap(){return this.tags}getTags(){return Object.values(this.tags)}getPackets(){return this.packets}serialize(){return this.packets.map((t=>t.serialize())).join("")}}String.fromCharCode(9);class F{constructor(){this.batchedData={}}registerSendPackets(t,e){t.getTags().forEach((r=>{const i=t.getPacket(r);if(0==i.dataBatching)return;const s=t.getChar(r);this.initiateBatch(s,i.dataBatching,e)}))}initiateBatch(t,e,r){this.batchedData[t]=[],r.setInterval((()=>{0!=this.batchedData[t].length&&(r.raw_send(t+this.batchedData[t].join("")),this.batchedData[t]=[])}),e)}batchPacket(t,e,r){this.batchedData[e].push(N(r.length,t.packetDelimitSize)+r)}static unravelBatch(t,e,r){const i=[];for(let s=0;s<e.length;){if(i.length>t.maxBatchSize)return"Too big of batch";const n=y(e.slice(s,s+=t.packetDelimitSize));if(s+n>e.length)return"Tampered batch length";const a=e.substring(s,s+=n),o=t.listen(a,r);if("string"==typeof o)return"Batched packet: "+o;i.push([o[0],!t.dontSpread])}return i}}class U{constructor(t){this.clientPackets=new $,this.serverPackets=new $,this.pastKeys=!1,this.readyListeners=[],this.sendQueue=[],this.timers=[],this.id=-1,this.socket=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.batcher=new F,this.invalidPacket=this.invalidPacket.bind(this),this.keyHandler=t=>this.serverKeyHandler(t),this.socket.addEventListener("message",this.keyHandler),this.socket.addEventListener("close",(t=>{this.listeners.close.forEach((e=>e(t))),this.timers.forEach(clearTimeout)}))}serverKeyHandler(t){const e=t.data.toString();if(!e.startsWith("SWS"))throw this.socket.close(1e3),new Error("The server requested is not a Sonic WS server.");const r=e.charCodeAt(3);if(9!=r)throw this.socket.close(1e3),new Error(`Version mismatch: ${r>9?"client":"server"} is outdated (server: ${r}, client: 9)`);const[i,s,n]=e.substring(4).split(o);this.clientPackets.holdPackets(x.deserializeAll(i,!0)),this.serverPackets.holdPackets(x.deserializeAll(s,!0)),this.batcher.registerSendPackets(this.clientPackets,this),Object.keys(this.preListen).forEach((t=>this.preListen[t].forEach((e=>{if(null==this.serverPackets.get(t))return console.error(new Error(`The server does not send the packet with tag "${t}"!`));this.listen(t,e)})))),this.preListen=null,this.pastKeys=!0,this.readyListeners.forEach((t=>t())),this.readyListeners=null,this.socket.removeEventListener("message",this.keyHandler),this.socket.addEventListener("message",(t=>this.messageHandler(t))),this.keyHandler=null}invalidPacket(t){throw console.log(t),new Error("An error occured with data from the server!! This is probably my fault.. make an issue at https://github.com/cutelittlelily/sonic-ws")}listenPacket(t,e){!function(t,e,r){if("string"==typeof t)return r(t);const[i,s]=t;try{s&&Array.isArray(i)?e.forEach((t=>t(...i))):e.forEach((t=>t(i)))}catch(t){r(t)}}(t,this.listeners.event[e],this.invalidPacket)}messageHandler(t){let e=t.data.toString();if(this.listeners.message.forEach((t=>t(e))),e.length<1)return;const r=e.substring(0,1),i=e.substring(1),s=r.charCodeAt(0);if(null==s)return;const n=this.serverPackets.getPacket(this.serverPackets.getTag(r));if(0==n.dataBatching)return void this.listenPacket(n.listen(i,null),s);const a=F.unravelBatch(n,i,null);if("string"==typeof a)return this.invalidPacket(a);a.forEach((t=>this.listenPacket(t,s)))}listen(t,e){const r=this.serverPackets.get(t);r?(this.listeners.event[r]||(this.listeners.event[r]=[]),this.listeners.event[r].push(e)):console.log("Key is not available on server: "+t)}raw_onmessage(t){this.listeners.message.push(t)}raw_send(t){this.socket.send(t)}send(t,...e){const[r,i,s]=function(t,e,r){const i=t.getChar(e);if(i==o)throw new Error(`Tag "${e}" has not been created!`);const s=t.getPacket(e);if(s.autoFlatten)r=B(r[0]);else{if(r.length>s.maxSize)throw new Error(`Packet "${e}" only allows ${s.maxSize} values!`);if(r.length<s.minSize)throw new Error(`Packet "${e}" requires at least ${s.minSize} values!`)}if(s.object){if(r=r.map((t=>Array.isArray(t)?t:[t])),!s.autoFlatten){const t=s.dataMin,i=s.dataMax;for(let s=0;s<t.length;s++){if(r[s].length<t[s])throw new Error(`Section ${s+1} of packet "${e}" requires at least ${t[s]} values!`);if(r[s].length>i[s])throw new Error(`Section ${s+1} of packet "${e}" only allows ${i[s]} values!`)}}}else{const t=r.find((t=>"object"==typeof t&&null!=t));t&&console.warn(`Passing an array will result in undefined behavior (${JSON.stringify(t)}). Spread the array with ...arr`)}return[i,r.length>0?s.processSend(r):"",s]}(this.clientPackets,t,e);0==s.dataBatching?this.raw_send(r+i):this.batcher.batchPacket(s,r,i)}on_ready(t){this.pastKeys?t():this.readyListeners.push(t)}on_close(t){this.listeners.close.push(t)}on(t,e){if(this.socket.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(e);this.listen(t,e)}setTimeout(t,e){const r=setTimeout(t,e);return this.timers.push(r),r}setInterval(t,e){const r=setInterval(t,e);return this.timers.push(r),r}}window.SonicWS=class extends U{constructor(t,e){super(new WebSocket(t,e))}WrapEnum(t,e){return function(t,e){if(!(e in i[t]))throw new Error(`Value "${e}" does not exist in enum "${t}"`);return String.fromCharCode(i[t][e])}(t,e)}FlattenData(t){return B(t)}UnFlattenData(t){return O(t)}}})();