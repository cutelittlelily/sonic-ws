/*!
 * SonicWS
 * (c) 2025 Lily (cutelittlelily)
 * Released under the Apache-2.0 License
 * https://www.apache.org/licenses/LICENSE-2.0
 */
(()=>{"use strict";const t={string:0,number:1,boolean:2,undefined:3,object:4},e={0:t=>t,1:t=>parseFloat(t),2:t=>"true"==t,3:()=>{},4:()=>null};class r{constructor(t,e){this.tag=t,this.values=e}serialize(){return String.fromCharCode(this.tag.length+1)+this.tag+String.fromCharCode(this.values.length+1)+this.values.map((e=>String.fromCharCode(String(e).length+1)+String.fromCharCode(function(e){const r=typeof e;if(!(r in t)&&null!=e)throw new Error(`Cannot serialize type "${r}" in an enum!`);return t[r]}(e)+1)+e)).join("")}}const n={},i={};function s(t,e){if(e.length>128)throw new Error("An enum can only hold 128 possible values.");return n[t]=Object.fromEntries(e.map(((t,e)=>[t,e]))),i[t]=Object.fromEntries(e.map(((t,e)=>[e,t]))),new r(t,e)}function a(t,e){const r=[];for(let n=0;n<t.length;n+=e)r.push(t.slice(n,n+e));return r}const o=String.fromCharCode(0),h=String.fromCharCode(1),c=String.fromCharCode(2),l=255,u=Math.floor(127.5),f=u+1,d=65535,g=Math.floor(32767.5),p=Number.MAX_SAFE_INTEGER,m=u+1,S=128,y=Math.floor(u/2)+1,w=Math.pow(m,7)-1,E=(Math.floor(w/2),[]),T=t=>{var e;return null!==(e=E[t])&&void 0!==e?e:E[t]=Math.pow(f,t)},v=[],k=t=>{var e;return null!==(e=v[t])&&void 0!==e?e:v[t]=Math.pow(m,t)},A=[],b=t=>{var e;return null!==(e=A[t])&&void 0!==e?e:A[t]=Math.pow(y,t)},N=[],C=t=>{var e;return null!==(e=N[t])&&void 0!==e?e:N[t]=Math.pow(2,t)};for(let t=0;t<=3;t++)T(t),k(t),b(t),C(t);function M(t){return Array.from(t,(t=>t.charCodeAt(0)))}function B(t){return 256*t[0]+t[1]}function R(t,e){if(!isFinite(t))throw new Error("Can only use real numbers in shorts: "+t);const r=e?g:d,n=e?-g-1:0;if(t>r||t<n)throw new Error(`${e?"Signed ":" "}Short Numbers must be within range ${n} and ${r}`);return[Math.floor(t/256),t%256]}function P(t){return R(t<0?-t+g:t,!1)}function U(t,e){if(!isFinite(t))throw new Error("Can only use real numbers in bytes: "+t);const r=e?u:l;if(t>r||t<-r-1)throw new Error(`${e?"Signed ":" "}Byte Numbers must be within range -${r+1} and ${r}: ${t}`);return t}function O(t){return t<=u?t:-t+u}function z(t){return(t=U(t,!0))<0?-t+u:t}function L(t,e){t=Math.abs(t);let r=1;for(let n=e(1);t>=n;n=e(++r));return r}const $=L(p,T);function I(t,e,r,n,i,s){if(!isFinite(t))throw new Error("Cannot use a non-finite number: "+t);if(0==t)return Array.from({length:e}).map((()=>0));if(1==e)return[r(t)];const a=t<0;if((t=Math.abs(t))>p)throw new Error(`Non-float numbers must be within range -${p.toLocaleString()} and ${p.toLocaleString()}: ${t}`);let o=[];const h=e-1;for(let e=0;e<h;e++){const r=s(h-e),n=Math.floor(t/r);o.push(n),t-=n*r}o.push(t%i);return a?o.map((t=>t>0?t+n:t)):o}function x(t,e){return I(t,e,z,u,f,T)}function D(t){return 0==t.length?O(t[0]):t.reduce(((t,e,r,n)=>t+O(e)*T(n.length-r-1)),0)}function _(t){return Number("0b"+t)}function F(t,e,r){return a(t.toString(2)+e.toString(2).padStart(8,"0")+r.toString(2).padStart(23,"0"),8).map((t=>_(t)))}function Z(t){if(isNaN(t))return F(0,255,4919);const e=t<0?1:0;if(0==(t=Math.abs(t)))return F(e,0,0);const r=Math.floor(Math.log(t)/Math.LN2);if(r>127||r<-126)return F(e,255,0);const n=t/C(r);return F(e,r+127,8388607&Math.round((n-1)*C(23)))}function H(t){const e=t.map((t=>t.toString(2).padStart(8,"0"))).join(""),r=_(e[0]),n=_(e.slice(1,9)),i=0===n?-126:n-127;return(0==r?1:-1)*function(t,e){const r=_(t);let n=0;for(let t=0;t<23;t++)r&1<<23-t-1&&(n+=C(-(t+1)));return(e?1:0)+n}(e.slice(9,32),0!==n)*C(i)}function j(t){return t<<1^t>>15}function V(t){return t>>>1^-(1&t)}function K(t){return R(j(t),!1)}function Y(t){return t<0?t|y:t}function G(t,e,r,n,i,s){if(t>r||t<e)throw new Error(`${s?"Signed ":""}Variable Ints must be within range ${e} and ${r}: ${t}`);return I(t,L(t,n),Y,y,i,n).map(((t,e)=>0==e?t:t|S)).reverse()}function W(t,e){return e?G(t,-w-1,w,b,y,!0):G(t,0,w,k,m,!1)}function q(t,e,r){let n,i=[];do{let r=t[e++];i.push(r),n=!!(r&S)}while(n);const s=r?b:k;return[e,i.reduce(((t,e,n)=>t+function(t,e){return e&&t&y?-(t^y):t}(n<i.length-1?e^S:e,r)*s(n)),0)]}function J(t,e){let r=[],n=0;for(;n<t.length;){const[i,s]=q(t,n,e);r.push(s),n=i}return r}var X;function Q(t,e){const r=new Uint8Array(1+e.length);return r[0]=t,r.set(e,1),r}function tt(t,e){return a(Array.from(t),e)}!function(t){t[t.NONE=0]="NONE",t[t.RAW=1]="RAW",t[t.STRINGS_UTF8=2]="STRINGS_UTF8",t[t.STRINGS_UTF16=3]="STRINGS_UTF16",t[t.STRINGS=2]="STRINGS",t[t.ENUMS=4]="ENUMS",t[t.BYTES=5]="BYTES",t[t.UBYTES=6]="UBYTES",t[t.BYTES_ZZ=7]="BYTES_ZZ",t[t.SHORTS=8]="SHORTS",t[t.USHORTS=9]="USHORTS",t[t.SHORTS_ZZ=10]="SHORTS_ZZ",t[t.NUMBERS=11]="NUMBERS",t[t.VARINT=12]="VARINT",t[t.UVARINT=13]="UVARINT",t[t.VARINT_ZZ=14]="VARINT_ZZ",t[t.DELTAS=15]="DELTAS",t[t.FLOAT=16]="FLOAT",t[t.BOOLEANS=17]="BOOLEANS"}(X||(X={}));const et=(t,e,r)=>t.length>=r&&t.length<=e,rt=(t,e,r)=>t.length>=2*r&&t.length<=2*e&&t.length%2==0,nt=(t,e,r)=>{if(0==t.length)return!1;let n=0,i=0;for(;i<t.length;){let r=!1,s=0;do{if(++s>7)return!1;r=!!(t[i++]&S)}while(r);if(++n>e)return!1}return!(n<r)},it={[X.NONE]:t=>0==t.length,[X.RAW]:()=>!0,[X.STRINGS_UTF8]:(t,e,r)=>{let n=0,i=0;for(;i<t.length;){if(n++,n>e)return!1;const[r,s]=q(t,i,!1);if(i=r+s,i>t.length)return!1}return!(n<r)},[X.STRINGS_UTF16]:(t,e,r)=>{let n=0,i=0;for(;i<t.length;){if(n++,n>e)return!1;const[r,s]=q(t,i,!1);if(i=r+2*s,i>t.length)return!1}return!(n<r)},[X.ENUMS]:(t,e,r,n,i)=>{if(t.length<r||t.length>e||i>=n.enumData.length)return!1;const s=n.enumData[i];for(let e=0;e<t.length;e++)if(s.values.length<=t[e])return!1;return!0},[X.BYTES]:et,[X.UBYTES]:et,[X.BYTES_ZZ]:et,[X.SHORTS]:rt,[X.USHORTS]:rt,[X.SHORTS_ZZ]:rt,[X.NUMBERS]:(t,e,r)=>{if(0==t.length)return!1;const n=t[0];if(n>$)return!1;const i=t.length-1;if(i%n!=0)return!1;const s=i/n;return!(s<r||s>e)},[X.VARINT]:nt,[X.UVARINT]:nt,[X.VARINT_ZZ]:nt,[X.DELTAS]:nt,[X.FLOAT]:(t,e,r)=>{let n=0;for(let r=0;r<t.length;r+=4){if(r+4>t.length)return!1;if(n++,n>e)return!1}return!(n<r)},[X.BOOLEANS]:(t,e,r)=>t.length>=Math.floor(r/8)&&t.length<=Math.floor(e/8)&&null==t.find((t=>t>255))},st={[X.NONE]:()=>"",[X.RAW]:t=>t,[X.STRINGS_UTF8]:t=>{const e=Array.from(t);let r=[];for(let t=0;t<e.length;t++){const[n,i]=q(e,t,!1),s=i;t=n-1,r.push(e.slice(t+1,t+1+s).map((t=>String.fromCharCode(t))).join("")),t+=s}return r},[X.STRINGS_UTF16]:t=>{const e=Array.from(t);let r=[];for(let t=0;t<e.length;t++){const[n,i]=q(e,t,!1),s=2*i;t=n-1,r.push(a(e.slice(t+1,t+1+s),2).map((t=>String.fromCharCode(B(t)))).join("")),t+=s}return r},[X.ENUMS]:(t,e,r,n)=>{const i=r.enumData[n];return Array.from(t).map((t=>i.values[t]))},[X.BYTES]:t=>Array.from(t).map(O),[X.UBYTES]:t=>Array.from(t),[X.BYTES_ZZ]:t=>Array.from(t).map(V),[X.SHORTS]:t=>tt(t,2).map((t=>function(t){const e=B(t);return e<=g?e:-e+g}(t))),[X.USHORTS]:t=>tt(t,2).map((t=>B(t))),[X.SHORTS_ZZ]:t=>tt(t,2).map((t=>V(B(t)))),[X.NUMBERS]:t=>a(t.slice(1),t[0]).map(D),[X.VARINT]:t=>J(Array.from(t),!0),[X.UVARINT]:t=>J(Array.from(t),!1),[X.VARINT_ZZ]:t=>J(Array.from(t),!1).map(V),[X.DELTAS]:t=>J(Array.from(t),!1).map(((t,e,r)=>r[e]=(r[e-1]||0)+V(t))),[X.FLOAT]:t=>tt(t,4).map(H),[X.BOOLEANS]:(t,e)=>Array.from(t).map((t=>{return e=t,[...Array(8)].map(((t,r)=>!!(e&1<<7-r)));var e})).flat().splice(0,e)},at={[X.NONE]:()=>[],[X.RAW]:t=>t.map((t=>M(String(t)))).flat(),[X.STRINGS_UTF8]:t=>{const e=[];for(const r of t){const t=String(r);e.push(...W(t.length,!1));const n=M(t),i=n.find((t=>t>l));if(i)throw new Error(`Cannot store code ${i} (${String.fromCharCode(i)}) in a UTF-8 String! Use STRINGS_UTF16.`);n.map((t=>e.push(t)))}return e},[X.STRINGS_UTF16]:t=>{const e=[];for(const r of t){const t=String(r);e.push(...W(t.length,!1)),M(t).map((t=>e.push(...R(t,!1))))}return e},[X.ENUMS]:t=>t,[X.BYTES]:t=>t.map(z),[X.UBYTES]:t=>t.map((t=>U(t,!1))),[X.BYTES_ZZ]:t=>t.map(j),[X.SHORTS]:t=>t.map(P).flat(),[X.USHORTS]:t=>t.map((t=>R(t,!1))).flat(),[X.SHORTS_ZZ]:t=>t.map(K).flat(),[X.NUMBERS]:t=>{const e=[],r=t.reduce(((t,e)=>Math.max(t,L(e,T))),1);return e.push(r),t.forEach((t=>x(t,r).forEach((t=>e.push(t))))),e},[X.VARINT]:t=>t.map((t=>W(t,!0))).flat(),[X.UVARINT]:t=>t.map((t=>W(t,!1))).flat(),[X.VARINT_ZZ]:t=>t.map((t=>W(j(t),!1))).flat(),[X.DELTAS]:t=>t.map(((e,r)=>W(j(e-(t[r-1]||0)),!1))).flat(),[X.FLOAT]:t=>t.map(Z).flat(),[X.BOOLEANS]:t=>a(t,8).map((t=>t.reduce(((t,e,r)=>t|e<<7-r),0))).flat()};class ot{constructor(t,e,r,n,i){this.tag=t,this.defaultEnabled=n,this.enumData=e.enumData,this.rateLimit=e.rateLimit,this.dontSpread=e.dontSpread,this.autoFlatten=e.autoFlatten,this.dataBatching=e.dataBatching,this.maxBatchSize=i?1/0:e.maxBatchSize,this.packetDelimitSize=e.packetDelimitSize,e.object?(this.type=e.types,this.dataMax=e.dataMaxes,this.dataMin=e.dataMins,this.maxSize=this.type.length,this.minSize=this.type.length,this.object=!0,this.receiveProcessor=function(t,e){const r=t.map((t=>st[t]));return(n,i,s)=>{let a=[],o=0;for(let h=0;h<n.length;){const c=D(n.slice(h,h+=e)),l=n.slice(h,h+=c);a.push(r[a.length](l,i[a.length],s,t[a.length]==X.ENUMS?o++:0))}return a}}(this.type,this.packetDelimitSize),this.validifier=function(t,e){const r=t.map((t=>it[t]));return(n,i,s,a)=>{let o=0,h=0;for(let c=0;c<n.length;){const l=D(n.slice(c,c+=e));if(l+c>n.length)return!1;const u=n.slice(c,c+=l);if(!r[o](u,i[o],s[o],a,t[o]==X.ENUMS?h++:0))return!1;if(++o>i.length)return!1}return!0}}(this.type,this.packetDelimitSize),this.sendProcessor=function(t){const e=t.type,r=t.packetDelimitSize,n=e.length,i=e.map((t=>at[t])),s=T(r);return t=>{let e=[];for(let a=0;a<n;a++){const n=t[a],o=i[a](Array.isArray(n)?n:[n]);if(o.length>s)throw new Error(`Cannot store ${o.length}/${s} bytes of data! Increase packetSize on the object!`);e.push(...x(o.length,r)),o.forEach((t=>e.push(t)))}return e}}(this)):(this.type=e.type,this.dataMax=e.dataMax,this.dataMin=e.dataMin,this.maxSize=this.dataMax,this.minSize=this.dataMin,this.object=!1,this.receiveProcessor=st[this.type],this.validifier=it[this.type],this.sendProcessor=at[this.type]),this.processReceive=t=>this.receiveProcessor(t,this.dataMax,this,0),this.processSend=t=>this.sendProcessor(t),this.validate=i?()=>!0:t=>this.validifier(t,this.dataMax,this.dataMin,this,0),this.customValidator=r,this.serializeBytePows=this.serializeBytePows.bind(this)}listen(t,e){try{if(!this.validate(t))return"Invalid packet";const r=this.processReceive(t),n=this.autoFlatten?lt(r):r;if(null!=this.customValidator)if(this.dontSpread){if(!this.customValidator(e,n))return"Didn't pass custom validator"}else if(!this.customValidator(e,...n))return"Didn't pass custom validator";return[n,!this.dontSpread]}catch(t){return console.error("There was an error processing the packet! This is probably my fault... report at https://github.com/cutelittlelily/sonic-ws",t),"Error: "+t}}serializeBytePows(t){return String.fromCharCode(...(e=t,r=this.packetDelimitSize,I(e,r,(t=>U(t,!1)),0,f,T)).map((t=>t+1)));var e,r}serialize(){const t=this.dontSpread?c:h,e=String.fromCharCode(this.enumData.length+1)+this.enumData.map((t=>t.serialize())).join(""),r=String.fromCharCode(this.dataBatching+1)+String.fromCharCode(this.maxBatchSize+1),n=String.fromCharCode(this.rateLimit+1);return this.object?t+r+n+e+String.fromCharCode(this.maxSize+2)+(this.autoFlatten?c:h)+String.fromCharCode(this.packetDelimitSize+1)+this.dataMax.map(this.serializeBytePows).join("")+this.dataMin.map(this.serializeBytePows).join("")+this.type.map((t=>String.fromCharCode(t+1))).join("")+String.fromCharCode(this.tag.length+1)+this.tag:t+r+n+e+h+String.fromCharCode(this.dataMax+1)+String.fromCharCode(this.dataMin+1)+String.fromCharCode(this.type+1)+String.fromCharCode(this.tag.length+1)+this.tag}static processBytePows(t,e){return a(M(t),e).map((t=>{return 0==(e=t.map((t=>t-1))).length?e[0]:e.reduce(((t,e,r,n)=>t+e*T(n.length-r-1)),0);var e}))}static deserialize(t,r,n){const i=r,a=t[r]==c,o=t.charCodeAt(++r)-1,h=t.charCodeAt(++r)-1,l=t.charCodeAt(++r)-1,u=t.charCodeAt(++r)-1,f=[];for(let n=0;n<u;n++){const n=t.charCodeAt(++r)-1,i=t.slice(++r,r+=n);r--;const a=t.charCodeAt(++r)-1,o=[];for(let n=0;n<a;n++){const n=t.charCodeAt(++r)-1,i=t.charCodeAt(++r)-1,s=t.slice(++r,r+=n);r--,o.push(e[i](s))}f.push(s(i,o))}const d=t.charCodeAt(++r)-2;if(-1!=d){const e=t[++r]==c,s=t.charCodeAt(++r)-1,u=d*s,g=++r,p=g+u,m=p,S=m+u,y=S,w=y+d,E=w+1,T=this.processBytePows(t.substring(g,p),s),v=this.processBytePows(t.substring(m,S),s),k=M(t.substring(y,w)).map((t=>t-1));let A=0;const b=k.map((t=>t==X.ENUMS?f[A++]:t)),N=t.charCodeAt(E-1)-1,C=t.substring(E,E+N),B=ht.object(b,T,v,a,e,s,o,h,l);return[new ot(C,B,null,!1,n),r-i+1+u+u+d+N]}const g=t.charCodeAt(++r)-1,p=t.charCodeAt(++r)-1,m=t.charCodeAt(++r)-1,S=m==X.ENUMS?f[0]:m,y=++r,w=t.charCodeAt(y)-1,E=t.substring(y+1,y+1+w),T=ht.single(S,g,p,a,o,h,l);return[new ot(E,T,null,!1,n),r-i+1+w]}static deserializeAll(t,e){const r=[];let n=0;for(;n<t.length;){const[i,s]=this.deserialize(t,n,e);r.push(i),n+=s}return r}}class ht{constructor(t){this.types=[],this.dataMaxes=[],this.dataMins=[],this.type=X.NONE,this.dataMax=-1,this.dataMin=-1,this.packetDelimitSize=1,this.dataBatching=0,this.maxBatchSize=10,this.rateLimit=0,this.enumData=[],this.dontSpread=!1,this.autoFlatten=!1,this.object=t}static single(t,e,r,n,i,s,a){const o=new ht(!1);return"number"==typeof t?(o.type=t,t==X.NONE&&(e=r=0)):(o.type=X.ENUMS,o.enumData=[t]),o.dataMax=e,o.dataMin=r,o.dontSpread=n,o.dataBatching=i,o.maxBatchSize=s,o.rateLimit=a,o}static object(t,e,r,n,i,s,a,o,h){if(t.length!=e.length||t.length!=r.length)throw new Error("There is an inbalance between the amount of types, data maxes, and data mins!");const c=new ht(!0);return t.forEach((t=>{"number"==typeof t?c.types.push(t):(c.types.push(X.ENUMS),c.enumData.push(t))})),c.dataMaxes=e,c.dataMins=r,c.dontSpread=n,c.autoFlatten=i,c.packetDelimitSize=s,c.dataBatching=a,c.maxBatchSize=o,c.rateLimit=h,c}}function ct(t){var e;if(null==t)return[];const r=t[0];if(null==r)return[];if(!Array.isArray(r))throw new Error(`Cannot flatten array: ${t}`);return null!==(e=r.map(((e,r)=>t.map((t=>t[r])))))&&void 0!==e?e:[]}function lt(t){var e,r;return null!==(r=null===(e=t[0])||void 0===e?void 0:e.map(((e,r)=>t.map((t=>t[r])))))&&void 0!==r?r:[]}class ut{constructor(t){this.key=1,this.keys={},this.tags={},this.packetMap={},t&&(this.packets=t,this.holdPackets(t))}createKey(t){this.keys[t]=this.key,this.tags[this.key]=t,this.key++}holdPackets(t){for(const e of t)this.createKey(e.tag),this.packetMap[e.tag]=e}getKey(t){if(!(t in this.keys))throw new Error(`Not a valid tag: ${t}`);return this.keys[t]}getChar(t){return String.fromCharCode(this.getKey(t))}getTag(t){return this.tags[t]}getPacket(t){if(!(t in this.packetMap))throw new Error("Unknown packet tag: "+t);return this.packetMap[t]}hasKey(t){return t in this.tags}hasTag(t){return t in this.keys}getKeys(){return this.keys}getTagMap(){return this.tags}getTags(){return Object.values(this.tags)}getPackets(){return this.packets}serialize(){return this.packets.map((t=>t.serialize())).join("")}}String.fromCharCode(9);class ft{constructor(){this.batchedData={}}registerSendPackets(t,e){t.getTags().forEach((r=>{const n=t.getPacket(r);if(0==n.dataBatching)return;const i=t.getKey(r);this.initiateBatch(i,n.dataBatching,e)}))}initiateBatch(t,e,r){this.batchedData[t]=[],r.setInterval((()=>{0!=this.batchedData[t].length&&(r.raw_send(Q(t,this.batchedData[t])),this.batchedData[t]=[])}),e)}batchPacket(t,e){const r=this.batchedData[t];r.push(...W(e.length,!1)),e.forEach((t=>r.push(t)))}static unravelBatch(t,e,r){const n=[];for(let i=0;i<e.length;){if(n.length>t.maxBatchSize)return"Too big of batch";const[s,a]=q(e,i,!1);if(i=s,i+a>e.length)return"Tampered batch length";const o=e.slice(i,i+=a),h=t.listen(o,r);if("string"==typeof h)return"Batched packet: "+h;n.push([h[0],!t.dontSpread])}return n}}var dt=function(t,e,r,n){return new(r||(r=Promise))((function(i,s){function a(t){try{h(n.next(t))}catch(t){s(t)}}function o(t){try{h(n.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class gt{constructor(t,e){this.clientPackets=new ut,this.serverPackets=new ut,this.pastKeys=!1,this.readyListeners=[],this.timers=[],this.id=-1,this.socket=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.batcher=new ft,this.invalidPacket=this.invalidPacket.bind(this),this.keyHandler=t=>this.serverKeyHandler(t),this.socket.addEventListener("message",this.keyHandler),this.socket.addEventListener("close",(t=>{this.listeners.close.forEach((e=>e(t))),this.timers.forEach(clearTimeout)})),this.bufferHandler=e}serverKeyHandler(t){const e=t.data.toString();if(!e.startsWith("SWS"))throw this.socket.close(1e3),new Error("The server requested is not a Sonic WS server.");const r=e.charCodeAt(3);if(9!=r)throw this.socket.close(1e3),new Error(`Version mismatch: ${r>9?"client":"server"} is outdated (server: ${r}, client: 9)`);const[n,i,s]=e.substring(4).split(o);this.clientPackets.holdPackets(ot.deserializeAll(n,!0)),this.serverPackets.holdPackets(ot.deserializeAll(i,!0)),this.batcher.registerSendPackets(this.clientPackets,this),Object.keys(this.preListen).forEach((t=>this.preListen[t].forEach((e=>{if(null==this.serverPackets.getKey(t))return console.error(new Error(`The server does not send the packet with tag "${t}"!`));this.listen(t,e)})))),this.preListen=null,this.pastKeys=!0,this.readyListeners.forEach((t=>t())),this.readyListeners=null,this.socket.removeEventListener("message",this.keyHandler),this.socket.addEventListener("message",(t=>this.messageHandler(t))),this.keyHandler=null}invalidPacket(t){throw console.log(t),new Error("An error occured with data from the server!! This is probably my fault.. make an issue at https://github.com/cutelittlelily/sonic-ws")}listenPacket(t,e){const r=this.listeners.event[e];if(!r)return console.warn("Warn: No listener for packet "+this.serverPackets.getTag(e));!function(t,e,r){if("string"==typeof t)return r(t);const[n,i]=t;try{i&&Array.isArray(n)?e.forEach((t=>t(...n))):e.forEach((t=>t(n)))}catch(t){r(t)}}(t,r,this.invalidPacket)}messageHandler(t){return dt(this,void 0,void 0,(function*(){const e=yield this.bufferHandler(t);if(this.listeners.message.forEach((t=>t(e))),e.length<1)return;const r=e[0],n=e.slice(1),i=this.serverPackets.getPacket(this.serverPackets.getTag(r));if(0==i.dataBatching)return void this.listenPacket(i.listen(n,null),r);const s=ft.unravelBatch(i,n,null);if("string"==typeof s)return this.invalidPacket(s);s.forEach((t=>this.listenPacket(t,r)))}))}listen(t,e){const r=this.serverPackets.getKey(t);r?(this.listeners.event[r]||(this.listeners.event[r]=[]),this.listeners.event[r].push(e)):console.log("Key is not available on server: "+t)}raw_onmessage(t){this.listeners.message.push(t)}raw_send(t){this.socket.send(t)}send(t,...e){const[r,n,i]=function(t,e,r){const n=t.getKey(e),i=t.getPacket(e);if(i.autoFlatten)r=ct(r[0]);else{if(r.length>i.maxSize)throw new Error(`Packet "${e}" only allows ${i.maxSize} values!`);if(r.length<i.minSize)throw new Error(`Packet "${e}" requires at least ${i.minSize} values!`)}if(i.object){if(r=r.map((t=>Array.isArray(t)?t:[t])),!i.autoFlatten){const t=i.dataMin,n=i.dataMax;for(let i=0;i<t.length;i++){if(r[i].length<t[i])throw new Error(`Section ${i+1} of packet "${e}" requires at least ${t[i]} values!`);if(r[i].length>n[i])throw new Error(`Section ${i+1} of packet "${e}" only allows ${n[i]} values!`)}}}else{const t=r.find((t=>"object"==typeof t&&null!=t));t&&console.warn(`Passing an array will result in undefined behavior (${JSON.stringify(t)}). Spread the array with ...arr`)}return[n,r.length>0?i.processSend(r):[],i]}(this.clientPackets,t,e);0==i.dataBatching?this.raw_send(Q(r,n)):this.batcher.batchPacket(r,n)}on_ready(t){this.pastKeys?t():this.readyListeners.push(t)}on_close(t){this.listeners.close.push(t)}on(t,e){if(this.socket.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(e);this.listen(t,e)}setTimeout(t,e){const r=setTimeout(t,e);return this.timers.push(r),r}setInterval(t,e){const r=setInterval(t,e);return this.timers.push(r),r}close(t,e){this.socket.close(t,e)}}var pt=function(t,e,r,n){return new(r||(r=Promise))((function(i,s){function a(t){try{h(n.next(t))}catch(t){s(t)}}function o(t){try{h(n.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};window.SonicWS=class extends gt{constructor(t,e){super(new WebSocket(t,e),(t=>pt(this,void 0,void 0,(function*(){return new Uint8Array(yield t.data.arrayBuffer())}))))}WrapEnum(t,e){return function(t,e){if(!(e in n[t]))throw new Error(`Value "${e}" does not exist in enum "${t}"`);return n[t][e]}(t,e)}FlattenData(t){return ct(t)}UnFlattenData(t){return lt(t)}}})();