(()=>{"use strict";function t(t,e){return function(t,e,n){if(n||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))}([],Array(Math.ceil(t.length/e)),!0).map((function(n,r){return t.slice(r*e,r*e+e)}))}var e,n,r,o,i=String.fromCharCode(0),s=Math.floor(27647.5),a=s+1,u=Math.log(a);function c(t){return t.split("").map((function(t){return t.charCodeAt(0)}))}function h(t){return t<s?t:-t+s}function f(t){if(t>=s||t<-s-1)throw new Error("INT_C Numbers must be within range -".concat(s+1," and ").concat(s));return String.fromCharCode(function(t){return t<0?-t+s:t}(t))}function l(t){return 0==t?1:Math.floor(Math.log(Math.abs(t))/u)+1}function p(t,e){if(0==t)return i;var n=t<0;t=Math.abs(t);for(var r="",o=0;o<e-1;o++){var u=Math.pow(a,e-o-1),h=Math.floor(t/u);r+=String.fromCharCode(h),t-=h*u}return r+=String.fromCharCode(t%a),n?c(r).map((function(t){return String.fromCharCode(t>0?t+s:t)})).join(""):r}function d(t){return c(t).reduce((function(t,e,n,r){return t+h(e)*Math.pow(a,r.length-n-1)}),0)}new TextEncoder,function(t){t[t.NONE=0]="NONE",t[t.RAW=1]="RAW",t[t.STRING=1]="STRING",t[t.INTS_C=2]="INTS_C",t[t.INTS_D=3]="INTS_D",t[t.DECIMAL=4]="DECIMAL",t[t.BOOLEAN=6]="BOOLEAN"}(o||(o={}));var y,v,g=((e={})[o.NONE]=function(t){return""==t},e[o.RAW]=function(){return!0},e[o.INTS_C]=function(t,e){return t.length==e},e[o.INTS_D]=function(t,e){return t.length>0&&c(t).length==t[0].charCodeAt(0)*e+1},e[o.DECIMAL]=function(t,e){return t.length>0&&c(t).length==t[0].charCodeAt(0)*e*2+1},e[o.BOOLEAN]=function(t){return t==i||""==t},e),C=((n={})[o.NONE]=function(t){return""},n[o.RAW]=function(t){return t},n[o.INTS_C]=function(t){return c(t).map(h)},n[o.INTS_D]=function(e){return t(c(e.substring(1)),e[0].charCodeAt(0)).map((function(t){return String.fromCharCode.apply(String,t)})).map(d)},n[o.DECIMAL]=function(e){var n=c(e),r=n.shift(),o=t(n,r).map((function(t){return String.fromCharCode.apply(String,t)})).map(d);return parseFloat(o[0]+"."+o[1])},n[o.BOOLEAN]=function(t){return t==i},n),S=((r={})[o.NONE]=function(t){return""},r[o.RAW]=function(t){return t.toString()},r[o.INTS_C]=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t.map(f).join("")},r[o.INTS_D]=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t.reduce((function(t,e){return Math.max(t,l(e))}),1),r=t.map((function(t){return p(t,n)})).join("");return String.fromCharCode(n)+r},r[o.DECIMAL]=function(t){var e=t.toString().split("."),n=parseFloat(e[0])||0,r=e.length>1&&parseFloat(e[1])||0,o=Math.max(l(n),l(r));return String.fromCharCode(o)+p(n,o)+p(r,o)},r[o.BOOLEAN]=function(t){return t?i:""},r),m=function(){function t(t){this.key=1,this.keys={},this.createKeys(t)}return t.prototype.createKey=function(t){t.includes(",")?console.log('Tag "'.concat(t,'" is invalid; keys cannot contain commas.')):(this.keys[t]=this.key,this.key++)},t.prototype.createKeys=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];this.createKey(r)}},t.prototype.get=function(t){return this.keys[t]},t.prototype.getChar=function(t){return String.fromCharCode(this.get(t))},t}(),E=function(){function t(t,e,n,r){this.processor=C[t],this.validifier=g[t],this.listener=e,this.dontSpread=r,this.dataCap=n}return t.prototype.listen=function(t){if(-1!=this.dataCap&&!this.validifier(t,this.dataCap))return!1;var e=this.processor(t);return Array.isArray(e)&&!this.dontSpread?this.listener.apply(this,e):this.listener(e),!0},t}(),N=function(){function t(t){var e=this;this.ws=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.clientKeys=new m([]),this.serverKeys=new m([]),this.ws.addEventListener("message",this.serverKeyHandler),this.ws.addEventListener("close",(function(t){e.listeners.close.forEach((function(e){return e(t)}))}))}return t.prototype.serverKeyHandler=function(t){var e=this,n=t.data.toString();if(!n.startsWith("SWS"))return this.ws.close(),void console.error("The server requested is not a Sonic WS server.");var r=n.split(";"),o=r[0],i=r[1];this.clientKeys.createKeys(o.split(",")),this.serverKeys.createKeys(i.split(",")),Object.keys(this.preListen).forEach((function(t){return e.preListen[t].forEach((function(n){return e.listen(t,n)}))})),this.ws.removeEventListener("message",this.serverKeyHandler),this.ws.addEventListener("message",this.messageHandler)},t.prototype.messageHandler=function(t){var e,n=t.data.toString();if(this.listeners.message.forEach((function(t){return t(n)})),!(n.length<1)){var r=n.substring(0,1),o=n.substring(1),i=r.charCodeAt(0);null!=i&&(null===(e=this.listeners.event[i])||void 0===e||e.forEach((function(t){return t.listen(o)})))}},t.prototype.listen=function(t,e){var n=this.serverKeys.get(t);n?(this.listeners.event[n]||(this.listeners.event[n]=[]),this.listeners.event[n].push(e)):console.log("Key is not available on server: "+t)},t.prototype.raw_onmessage=function(t){this.listeners.message.push(t)},t.prototype.raw_send=function(t){this.ws.send(t)},t.prototype.send=function(t,e){void 0===e&&(e=o.NONE);for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=this.clientKeys.getChar(t);if(null==i)throw new Error('Key "'.concat(t,'" has not been created!'));this.raw_send(i+S[e].apply(S,n))},t.prototype.on_ready=function(t){this.ws.readyState===WebSocket.OPEN?t():this.ws.addEventListener("open",t)},t.prototype.on_close=function(t){this.listeners.close.push(t),this.ws.addEventListener("close",t)},t.prototype.on=function(t,e,n,r){void 0===r&&(r=!1);var o=new E(e,n,-1,r);if(this.ws.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(o);this.listen(t,o)},t}(),w=(y=function(t,e){return y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},y(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}y(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});window.SonicWS=((v=function(t){function e(e,n){var r=new WebSocket(e,n);return t.call(this,r)||this}return w(e,t),e}(N)).PacketType=o,v)})();