(()=>{"use strict";function t(t,e){return function(t,e,n){if(n||2===arguments.length)for(var r,i=0,o=e.length;i<o;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))}([],Array(Math.ceil(t.length/e)),!0).map((function(n,r){return t.slice(r*e,r*e+e)}))}var e,n,r,i,o,s=String.fromCharCode(0),a=Math.floor(27647.5),c=a+1,u=Math.log(c);function h(t){return t.split("").map((function(t){return t.charCodeAt(0)}))}function f(t){return t<a?t:-t+a}function p(t){if(t>=a||t<-a-1)throw new Error("INT_C Numbers must be within range -".concat(a+1," and ").concat(a));return String.fromCharCode(function(t){return t<0?-t+a:t}(t))}function l(t){return 0==t?1:Math.floor(Math.log(Math.abs(t))/u)+1}function d(t,e){if(0==t)return s;var n=t<0;t=Math.abs(t);for(var r="",i=0;i<e-1;i++){var o=Math.pow(c,e-i-1),u=Math.floor(t/o);r+=String.fromCharCode(u),t-=u*o}return r+=String.fromCharCode(t%c),n?h(r).map((function(t){return String.fromCharCode(t>0?t+a:t)})).join(""):r}function g(t){return h(t).reduce((function(t,e,n,r){return t+f(e)*Math.pow(c,r.length-n-1)}),0)}new TextEncoder,(o=i||(i={}))[o.NONE=0]="NONE",o[o.RAW=1]="RAW",o[o.STRING=1]="STRING",o[o.INTS_C=2]="INTS_C",o[o.INTS_D=3]="INTS_D",o[o.DECIMAL=4]="DECIMAL",o[o.BOOLEAN=6]="BOOLEAN";var y,v,C=((e={})[i.NONE]=function(t){return""==t},e[i.RAW]=function(){return!0},e[i.INTS_C]=function(t,e){return t.length==e},e[i.INTS_D]=function(t,e){return t.length>0&&h(t).length==t[0].charCodeAt(0)*e+1},e[i.DECIMAL]=function(t,e){return t.length>0&&h(t).length==t[0].charCodeAt(0)*e*2+1},e[i.BOOLEAN]=function(t){return t==s||""==t},e),S=((n={})[i.NONE]=function(t){return""},n[i.RAW]=function(t){return t},n[i.INTS_C]=function(t){return h(t).map(f)},n[i.INTS_D]=function(e){return t(h(e.substring(1)),e[0].charCodeAt(0)).map((function(t){return String.fromCharCode.apply(String,t)})).map(g)},n[i.DECIMAL]=function(e){var n=h(e),r=n.shift(),i=t(n,r).map((function(t){return String.fromCharCode.apply(String,t)})).map(g);return parseFloat(i[0]+"."+i[1])},n[i.BOOLEAN]=function(t){return t==s},n),m=((r={})[i.NONE]=function(t){return""},r[i.RAW]=function(t){return t.toString()},r[i.INTS_C]=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t.map(p).join("")},r[i.INTS_D]=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t.reduce((function(t,e){return Math.max(t,l(e))}),1),r=t.map((function(t){return d(t,n)})).join("");return String.fromCharCode(n)+r},r[i.DECIMAL]=function(t){var e=t.toString().split("."),n=parseFloat(e[0])||0,r=e.length>1&&parseFloat(e[1])||0,i=Math.max(l(n),l(r));return String.fromCharCode(i)+d(n,i)+d(r,i)},r[i.BOOLEAN]=function(t){return t?s:""},r),k=function(){function t(t,e,n,r){this.tag=t,this.type=e,this.dataCap=n,this.dontSpread=r}return t.prototype.serialize=function(){return"".concat(this.dontSpread?1:0).concat(String.fromCharCode(this.dataCap+1)).concat(String.fromCharCode(this.type+1)).concat(String.fromCharCode(this.tag.length+1)).concat(this.tag)},t.deserialize=function(e,n){var r="1"==e[n],i=e.charCodeAt(n+1)-1,o=e.charCodeAt(n+2)-1,s=e.charCodeAt(n+3)-1;return[new t(e.substring(n+4,n+4+s),o,i,r),s]},t.deserializeAll=function(t){for(var e=[],n=0;n<t.length;){var r=this.deserialize(t,n),i=r[0],o=r[1];e.push(i),n+=4+o}return e},t}(),w=function(){function t(t){this.key=1,this.keys={},this.tags={},this.packets=t,this.packetMap={},this.createPackets(t)}return t.prototype.createKey=function(t){t.includes(",")?console.log('Tag "'.concat(t,'" is invalid; keys cannot contain commas.')):(this.keys[t]=this.key,this.tags[this.key]=t,this.key++)},t.prototype.createPackets=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];this.createKey(r.tag),this.packetMap[r.tag]=r}},t.prototype.get=function(t){return this.keys[t]},t.prototype.getChar=function(t){return String.fromCharCode(this.get(t))},t.prototype.getPacket=function(t){return this.packetMap[t]},t.prototype.has=function(t){return null!=this.tags[t.charCodeAt(0)]},t.prototype.getKeys=function(){return this.keys},t.prototype.serialize=function(){return this.packets.map((function(t){return t.serialize()})).join(",")},t.empty=function(){return new t([])},t}(),A=function(){function t(t,e){this.processor=S[t.type],this.validifier=C[t.type],this.listener=e,this.dontSpread=t.dontSpread,this.dataCap=t.dataCap}return t.prototype.listen=function(t){if(!this.validifier(t,this.dataCap))return!1;var e=this.processor(t);return Array.isArray(e)&&!this.dontSpread?this.listener.apply(this,e):this.listener(e),!0},t}(),E=function(){function t(t){var e=this;this.clientPackets=w.empty(),this.serverPackets=w.empty(),this.ws=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.keyHandler=function(t){return e.serverKeyHandler(t)},this.ws.addEventListener("message",this.keyHandler),this.ws.addEventListener("close",(function(t){e.listeners.close.forEach((function(e){return e(t)}))}))}return t.prototype.serverKeyHandler=function(t){var e=this,n=t.data.toString();if(!n.startsWith("SWS"))return this.ws.close(),void console.error("The server requested is not a Sonic WS server.");var r=n.substring(3).split(s),i=r[0],o=r[1];this.clientPackets.createPackets(k.deserializeAll(i)),this.serverPackets.createPackets(k.deserializeAll(o)),Object.keys(this.preListen).forEach((function(t){return e.preListen[t].forEach((function(n){var r=e.serverPackets.getPacket(t),i=new A(r,n);e.listen(t,i)}))})),this.ws.removeEventListener("message",this.keyHandler),this.ws.addEventListener("message",(function(t){return e.messageHandler(t)}))},t.prototype.messageHandler=function(t){var e,n=t.data.toString();if(this.listeners.message.forEach((function(t){return t(n)})),!(n.length<1)){var r=n.substring(0,1),i=n.substring(1),o=r.charCodeAt(0);null!=o&&(null===(e=this.listeners.event[o])||void 0===e||e.forEach((function(t){return t.listen(i)})))}},t.prototype.listen=function(t,e){var n=this.serverPackets.get(t);n?(this.listeners.event[n]||(this.listeners.event[n]=[]),this.listeners.event[n].push(e)):console.log("Key is not available on server: "+t)},t.prototype.raw_onmessage=function(t){this.listeners.message.push(t)},t.prototype.raw_send=function(t){this.ws.send(t)},t.prototype.send=function(t){for(var e=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];!function(t,e,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];var o=t.getChar(n);if(null==o)throw new Error('Tag "'.concat(n,'" has not been created!'));var s=t.getPacket(n);if(r.length>s.dataCap)throw new Error('Packet "'.concat(n,'" only allows ').concat(s.dataCap," values!"));e(o+m[s.type].apply(m,r))}(this.clientPackets,(function(t){return e.raw_send(t)}),t,n)},t.prototype.on_ready=function(t){this.ws.readyState===WebSocket.OPEN?t():this.ws.addEventListener("open",t)},t.prototype.on_close=function(t){this.listeners.close.push(t)},t.prototype.on=function(t,e){if(this.ws.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(e);var n=this.serverPackets.getPacket(t),r=new A(n,e);this.listen(t,r)},t}(),N=(y=function(t,e){return y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},y(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}y(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});window.SonicWS=((v=function(t){function e(e,n){var r=new WebSocket(e,n);return t.call(this,r)||this}return N(e,t),e}(E)).PacketType=i,v)})();