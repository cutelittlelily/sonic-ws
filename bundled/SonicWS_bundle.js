(()=>{"use strict";function t(t,e){return[...Array(Math.ceil(t.length/e))].map(((r,s)=>t.slice(s*e,s*e+e)))}const e=String.fromCharCode(0),r=(String.fromCharCode(1),Math.floor(27647.5)),s=r+1,n=[];function i(t){return t.split("").map((t=>t.charCodeAt(0)))}function a(t){return t<r?t:-t+r}function o(t){if(t>=r||t<-r-1)throw new Error(`INT_C Numbers must be within range -${r+1} and ${r}`);return String.fromCharCode(function(t){return t<0?-t+r:t}(t))}function h(t){if(0==t)return 1;let e=1,r=s;for(;t>r;)e++,r*=s;return e}function c(t,n){if(0==t)return e;const a=t<0;t=Math.abs(t);let o="";for(let e=0;e<n-1;e++){const r=Math.pow(s,n-e-1),i=Math.floor(t/r);o+=String.fromCharCode(i),t-=i*r}return o+=String.fromCharCode(t%s),a?i(o).map((t=>String.fromCharCode(t>0?t+r:t))).join(""):o}function l(t){return d(i(t))}function d(t){return t.reduce(((t,e,r,i)=>t+a(e)*function(t){var e;return null!==(e=n[t])&&void 0!==e?e:n[t]=Math.pow(s,t)}(i.length-r-1)),0)}var u,g;new TextEncoder,(g=u||(u={}))[g.NONE=0]="NONE",g[g.RAW=1]="RAW",g[g.STRINGS=2]="STRINGS",g[g.INTS_C=3]="INTS_C",g[g.INTS_D=4]="INTS_D",g[g.INTS_A=5]="INTS_A",g[g.DECIMALS=6]="DECIMALS",g[g.BOOLEANS=7]="BOOLEANS";const p=(t,e)=>{let r=0;for(let s=0;s<t.length;s++){if(r++,r>e)return!1;if(s+=t.charCodeAt(s),s+1>t.length)return!1}return!0},S={[u.NONE]:t=>""==t,[u.RAW]:()=>!0,[u.STRINGS]:p,[u.INTS_C]:(t,e)=>t.length==e,[u.INTS_D]:(t,e)=>t.length>0&&(i(t).length-1)%t[0].charCodeAt(0)<=e,[u.INTS_A]:p,[u.DECIMALS]:(t,e)=>{let r=0;for(let s=0;s<t.length;s++){if(r++,r>e)return!1;if(s+=t.charCodeAt(s++),s>t.length)return!1;if(s+=t.charCodeAt(s++),s>t.length)return!1}return!0},[u.BOOLEANS]:(t,e)=>{const r=i(t);return r.length<=Math.floor(e/8)+1&&null==r.find((t=>t>255))}},f={[u.NONE]:t=>"",[u.RAW]:t=>t,[u.STRINGS]:t=>{let e=[];for(let r=0;r<t.length;r++){const s=t.charCodeAt(r);e.push(t.substring(r+1,r+1+s)),r+=s}return e},[u.INTS_C]:t=>i(t).map(a),[u.INTS_D]:e=>t(i(e.substring(1)),e[0].charCodeAt(0)).map((t=>String.fromCharCode(...t))).map(l),[u.INTS_A]:t=>{let e=[];for(let r=0;r<t.length;r++){const s=t.charCodeAt(r);e.push(l(t.substring(r+1,r+1+s))),r+=s}return e},[u.DECIMALS]:t=>{const e=i(t);let r=[];for(let t=0;t<e.length;){const s=e[t++],n=d(e.slice(t,t+s));t+=s;const i=e[t++],a=d(e.slice(t,t+i));t+=i,r.push(parseFloat(n+"."+a))}return r},[u.BOOLEANS]:(t,e)=>i(t).map((t=>{return e=t,[...Array(8)].map(((t,r)=>!!(e&1<<7-r)));var e})).flat().splice(0,e)},C={[u.NONE]:t=>"",[u.RAW]:t=>t.toString(),[u.STRINGS]:(...t)=>t.map((t=>String.fromCharCode(t.toString().length)+t)).join(""),[u.INTS_C]:(...t)=>t.map(o).join(""),[u.INTS_D]:(...t)=>{const e=t.reduce(((t,e)=>Math.max(t,h(e))),1),r=t.map((t=>c(t,e))).join("");return String.fromCharCode(e)+r},[u.INTS_A]:(...t)=>t.map((t=>{const e=h(t);return String.fromCharCode(e)+c(t,e)})).join(""),[u.DECIMALS]:(...t)=>t.map((t=>{const e=t.toString().split("."),r=parseFloat(e[0])||0,s=e.length>1&&parseFloat(e[1])||0,n=h(r),i=h(s);return String.fromCharCode(n)+c(r,n)+String.fromCharCode(i)+c(s,i)})).join(""),[u.BOOLEANS]:(...e)=>t(e,8).map((t=>String.fromCharCode(t.reduce(((t,e,r)=>t|e<<7-r),0)))).join("")};class m{constructor(t,e,r,s){this.tag=t,this.type=e,this.dataCap=r,this.dontSpread=s}serialize(){return`${this.dontSpread?1:0}${String.fromCharCode(this.dataCap+1)}${String.fromCharCode(this.type+1)}${String.fromCharCode(this.tag.length+1)}${this.tag}`}static deserialize(t,e){const r="1"==t[e],s=t.charCodeAt(e+1)-1,n=t.charCodeAt(e+2)-1,i=t.charCodeAt(e+3)-1,a=t.substring(e+4,e+4+i);return[new m(a,n,s,r),i]}static deserializeAll(t){const e=[];let r=0;for(;r<t.length;){const[s,n]=this.deserialize(t,r);e.push(s),r+=4+n}return e}}class y{constructor(t){this.key=1,this.keys={},this.tags={},this.packets=t,this.packetMap={},this.createPackets(t)}createKey(t){t.includes(",")?console.log(`Tag "${t}" is invalid; keys cannot contain commas.`):(this.keys[t]=this.key,this.tags[this.key]=t,this.key++)}createPackets(t){for(const e of t)this.createKey(e.tag),this.packetMap[e.tag]=e}get(t){return this.keys[t]}getChar(t){return String.fromCharCode(this.get(t))}getPacket(t){return this.packetMap[t]}has(t){return null!=this.tags[t.charCodeAt(0)]}getKeys(){return this.keys}serialize(){return this.packets.map((t=>t.serialize())).join("")}static empty(){return new y([])}}class A{constructor(t,e){this.processor=f[t.type],this.validifier=S[t.type],this.listener=e,this.dontSpread=t.dontSpread,this.dataCap=t.dataCap}listen(t){try{if(!this.validifier(t,this.dataCap))return!1;const e=this.processor(t,this.dataCap);return Array.isArray(e)&&!this.dontSpread?this.listener(...e):this.listener(e),!0}catch(t){return console.error(t),!1}}}class k{constructor(t){this.clientPackets=y.empty(),this.serverPackets=y.empty(),this.pastKeys=!1,this.readyListeners=[],this.ws=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.keyHandler=t=>this.serverKeyHandler(t),this.ws.addEventListener("message",this.keyHandler),this.ws.addEventListener("close",(t=>{this.listeners.close.forEach((e=>e(t)))}))}serverKeyHandler(t){const r=t.data.toString();if(!r.startsWith("SWS"))throw this.ws.close(),new Error("The server requested is not a Sonic WS server.");const s=r.charCodeAt(3);if(1!=s)throw this.ws.close(),new Error(`Version mismatch: ${s>1?"client":"server"} is outdated (server: ${s}, client: 1)`);const[n,i]=r.substring(4).split(e);this.clientPackets.createPackets(m.deserializeAll(n)),this.serverPackets.createPackets(m.deserializeAll(i)),Object.keys(this.preListen).forEach((t=>this.preListen[t].forEach((e=>{if(null==this.serverPackets.get(t))return console.error(new Error(`The server does not send the packet with tag "${t}"!`));const r=this.serverPackets.getPacket(t),s=new A(r,e);this.listen(t,s)})))),this.pastKeys=!0,this.readyListeners.forEach((t=>t())),this.ws.removeEventListener("message",this.keyHandler),this.ws.addEventListener("message",(t=>this.messageHandler(t)))}messageHandler(t){var e;let r=t.data.toString();if(this.listeners.message.forEach((t=>t(r))),r.length<1)return;const s=r.substring(0,1),n=r.substring(1),i=s.charCodeAt(0);null!=i&&(null===(e=this.listeners.event[i])||void 0===e||e.forEach((t=>{if(!t.listen(n))throw new Error("An error occured with data from the server!! This is probably my fault.. make an issue at https://github.com/cutelittlelily/sonic-ws")})))}listen(t,e){const r=this.serverPackets.get(t);r?(this.listeners.event[r]||(this.listeners.event[r]=[]),this.listeners.event[r].push(e)):console.log("Key is not available on server: "+t)}raw_onmessage(t){this.listeners.message.push(t)}raw_send(t){this.ws.send(t)}send(t,...r){!function(t,r,s,...n){const i=t.getChar(s);if(i==e)throw new Error(`Tag "${s}" has not been created!`);const a=t.getPacket(s);if(n.length>a.dataCap)throw new Error(`Packet "${s}" only allows ${a.dataCap} values!`);r(i+C[a.type](...n))}(this.clientPackets,(t=>this.raw_send(t)),t,...r)}on_ready(t){this.pastKeys?t():this.readyListeners.push(t)}on_close(t){this.listeners.close.push(t)}on(t,e){if(this.ws.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(e);const r=this.serverPackets.getPacket(t),s=new A(r,e);this.listen(t,s)}}var w;window.SonicWS=((w=class extends k{constructor(t,e){super(new WebSocket(t,e))}}).PacketType=u,w)})();